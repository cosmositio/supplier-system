<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COA Ar≈üiv - Analiz Sertifikasƒ± Y√∂netimi</title>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <!-- PDF.js for PDF compression -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- SheetJS for Excel reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #2d5a3d 0%, #4a8f5c 100%);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header h1 {
            font-size: 1.6em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
            color: #2d5a3d;
        }
        
        .stat-card .label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
        }
        
        /* Mobile Responsive Design */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 350px 1fr;
            }
        }
        
        @media (max-width: 900px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            /* Mobile Layout Order */
            .container {
                display: flex;
                flex-direction: column;
            }
            
            #statsSection {
                order: 3; /* ƒ∞statistikler en alta */
                margin-top: 30px;
                margin-bottom: 20px;
            }
            
            .main-grid {
                order: 2; /* Form ve tablo ortada */
                display: flex;
                flex-direction: column;
            }
            
            .main-grid > .card:first-child {
                order: 1; /* Form √∂nce */
                margin-bottom: 20px;
            }
            
            .main-grid > .card:last-child {
                order: 2; /* Tablo sonra */
            }
            
            .header {
                padding: 15px 20px;
            }
            
            .header h1 {
                font-size: 1.3em;
            }
            
            .container {
                padding: 0 15px;
            }
        }
        
        @media (max-width: 768px) {
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stat-card {
                padding: 18px;
            }
            
            .stat-card .number {
                font-size: 1.8em;
            }
            
            .stat-card .label {
                font-size: 1em;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .filters input,
            .filters select {
                width: 100%;
                min-width: auto;
                padding: 14px;
                font-size: 16px;
            }
            
            .card {
                padding: 25px 20px;
            }
            
            .card h2 {
                font-size: 1.3em;
                margin-bottom: 25px;
            }
            
            .form-group {
                margin-bottom: 20px;
            }
            
            .form-group label {
                font-size: 1.05em;
                margin-bottom: 8px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 14px;
                font-size: 16px; /* Prevent zoom on iOS */
                border-width: 2px;
            }
            
            .upload-area {
                padding: 35px 20px;
                min-height: 200px;
            }
            
            .upload-icon {
                font-size: 3em;
            }
            
            .upload-text {
                font-size: 1.05em;
            }
            
            .btn {
                padding: 16px 24px;
                font-size: 1.05em;
            }
            
            /* Tablo mobil optimize */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 800px; /* Kaydƒ±rma i√ßin */
            }
        }
        
        @media (max-width: 480px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px;
                gap: 10px;
            }
            
            .header h1 {
                font-size: 1.2em;
            }
            
            .back-btn {
                padding: 10px 18px;
                font-size: 0.95em;
            }
            
            .stats-bar {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-card .number {
                font-size: 2em;
            }
            
            .stat-card .label {
                font-size: 1.05em;
            }
            
            .card {
                padding: 20px 15px;
            }
            
            .card h2 {
                font-size: 1.2em;
            }
            
            .form-group input,
            .form-group select {
                padding: 16px;
                font-size: 16px;
            }
            
            .upload-area {
                padding: 30px 15px;
            }
            
            .btn {
                padding: 15px 20px;
                font-size: 1.05em;
                font-weight: 700;
            }
            
            table {
                font-size: 0.9em;
            }
            
            th, td {
                padding: 10px 8px;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 8px;
            }
            
            .btn-sm {
                padding: 10px 14px;
                font-size: 0.9em;
                width: 100%;
                justify-content: center;
            }
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .card h2 {
            color: #2d5a3d;
            margin-bottom: 20px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2d5a3d;
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }
        
        .upload-area:hover {
            border-color: #2d5a3d;
            background: #f0f7f2;
        }
        
        .upload-area.has-file {
            border-color: #28a745;
            background: #e8f5e9;
        }
        
        .upload-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .upload-text {
            color: #666;
        }
        
        .file-name {
            margin-top: 10px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 8px;
            color: #2d5a3d;
            font-weight: 600;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 8px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2d5a3d 0%, #4a8f5c 100%);
            color: white;
            width: 100%;
            justify-content: center;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(45, 90, 61, 0.3);
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 0.85em;
        }
        
        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filters input,
        .filters select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95em;
        }
        
        .filters input {
            flex: 1;
            min-width: 200px;
        }
        
        /* Multiselect */
        .multiselect-container {
            position: relative;
            min-width: 280px;
        }
        
        .multiselect-header {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .multiselect-header:hover {
            border-color: #2196F3;
        }
        
        .multiselect-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 320px;
            background: white;
            border: 2px solid #2196F3;
            border-radius: 8px;
            margin-top: 5px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
        }
        
        .multiselect-dropdown.active {
            display: block;
        }
        
        .multiselect-option {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            white-space: nowrap;
        }
        
        .multiselect-option:hover {
            background: #f5f5f5;
        }
        
        .multiselect-option input[type="checkbox"] {
            cursor: pointer;
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        
        .multiselect-option label {
            cursor: pointer;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .multiselect-search {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
            background: white;
        }
        
        .multiselect-search input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .multiselect-actions {
            padding: 10px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            position: sticky;
            bottom: 0;
            background: white;
        }
        
        .multiselect-actions button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }
        
        .multiselect-actions .select-all {
            background: #4CAF50;
            color: white;
        }
        
        .multiselect-actions .clear-all {
            background: #f44336;
            color: white;
        }
        
        /* Table */
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .thumbnail {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .thumbnail:hover {
            transform: scale(1.1);
        }
        
        .pdf-icon {
            width: 50px;
            height: 50px;
            background: #dc3545;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.8em;
            cursor: pointer;
        }
        
        .actions {
            display: flex;
            gap: 5px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
        }
        
        .modal-content img {
            max-width: 100%;
            display: block;
        }
        
        .modal-close {
            position: fixed;
            top: 20px;
            right: 30px;
            font-size: 40px;
            color: white;
            cursor: pointer;
        }
        
        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast {
            background: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            margin-top: 10px;
            animation: slideIn 0.3s ease;
        }
        
        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }
        .toast.warning { background: #ffc107; color: #333; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state .icon {
            font-size: 4em;
            margin-bottom: 15px;
        }
        
        /* Settings */
        .settings-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .settings-section h3 {
            font-size: 0.95em;
            color: #666;
            margin-bottom: 10px;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #dc3545;
        }
        
        .status-dot.connected {
            background: #28a745;
        }
        
        /* Tedarik√ßi dropdown stilleri */
        .supplier-input-container {
            position: relative;
        }
        
        .supplier-input-wrapper {
            position: relative;
        }
        
        .supplier-dropdown-arrow {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #999;
            font-size: 0.8em;
        }
        
        #supplierInput {
            padding-right: 35px;
        }
        
        .supplier-dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }
        
        .supplier-dropdown-list.active {
            display: block;
        }
        
        .supplier-dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .supplier-dropdown-item:hover {
            background: #f0f7ff;
        }
        
        .supplier-dropdown-item.selected {
            background: #e3f2fd;
            font-weight: 600;
        }
        
        .supplier-dropdown-empty {
            padding: 20px;
            text-align: center;
            color: #999;
        }
        
        .supplier-dropdown-count {
            padding: 8px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.85em;
            color: #666;
            position: sticky;
            top: 0;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã COA Ar≈üiv Sistemi</h1>
        <a href="index.html" class="back-btn">‚Üê Ana Sayfa</a>
    </div>
    
    <div class="container">
        <!-- Stats - Mobilde en alta gidecek -->
        <div class="stats-bar" id="statsSection">
            <div class="stat-card">
                <div class="number" id="statTotal">0</div>
                <div class="label">Toplam Sertifika</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statSuppliers">0</div>
                <div class="label">Tedarik√ßi</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statThisMonth">0</div>
                <div class="label">Bu Ay</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statTotalSize">0 MB</div>
                <div class="label">Toplam Dosya</div>
            </div>
            <div class="stat-card">
                <div class="connection-status">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">Baƒülantƒ± kontrol ediliyor...</span>
                </div>
            </div>
        </div>
        
        <div class="main-grid">
            <!-- Form -->
            <div class="card">
                <h2>üì§ Yeni Sertifika Ekle</h2>
                
                <div class="form-group">
                    <label>Tedarik√ßi Firma * <span id="supplierCount" style="color:#2196F3; font-weight:normal; font-size:0.9em;"></span></label>
                    <div class="supplier-input-container">
                        <div class="supplier-input-wrapper">
                            <input type="text" 
                                   id="supplierInput" 
                                   placeholder="Tedarik√ßi ara veya yazƒ±n..." 
                                   autocomplete="off"
                                   onfocus="showSupplierDropdown()"
                                   oninput="filterSupplierDropdown()"
                                   onchange="filterMaterialsBySupplier()">
                            <span class="supplier-dropdown-arrow">‚ñº</span>
                            <div class="supplier-dropdown-list" id="supplierDropdownList">
                                <div class="supplier-dropdown-count" id="supplierDropdownCount"></div>
                                <div id="supplierDropdownItems"></div>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; margin-top: 8px; flex-wrap: wrap;">
                        <small style="color:#666; font-size:0.85em; flex: 1; min-width: 200px;">Excel dosyasƒ± y√ºkleyerek tedarik√ßi ve hammadde listelerini otomatik doldurun</small>
                        <label for="excelFileInput" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; padding: 10px 20px; border-radius: 8px; font-size: 0.9em; cursor: pointer; white-space: nowrap; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(46, 204, 113, 0.3);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(46, 204, 113, 0.4)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(46, 204, 113, 0.3)'">
                            üìä Excel Y√ºkle
                        </label>
                        <input type="file" id="excelFileInput" accept=".xlsx,.xls" onchange="loadExcelFile(event)" style="display: none;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Hammadde Kodu * <span id="materialCount" style="font-size: 0.8em; color: #666;"></span></label>
                    <div class="supplier-dropdown-wrapper" style="position: relative;">
                        <input type="text" id="materialCode" placeholder="üîç Hammadde ara veya yazƒ±n..." 
                               autocomplete="off" 
                               oninput="filterMaterials(this.value)" 
                               onfocus="showMaterialDropdown()" 
                               style="width: 100%;">
                        <div id="materialDropdown" class="supplier-dropdown-list" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 0 0 8px 8px; max-height: 250px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                            <div style="padding: 8px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                                <span id="materialDropdownCount" style="font-size: 0.85em; color: #666; font-weight: 500;">0 hammadde</span>
                            </div>
                            <div id="materialDropdownItems"></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ƒ∞rsaliye Tarihi *</label>
                    <input type="date" id="deliveryDate">
                </div>
                
                <div class="form-group">
                    <label>ƒ∞rsaliye No</label>
                    <input type="text" id="deliveryNo" placeholder="√ñrn: IRS-2024-001">
                </div>
                
                <div class="form-group">
                    <label>Parti/Lot No</label>
                    <input type="text" id="lotNumber" placeholder="√ñrn: 2I02618">
                </div>
                
                <div class="form-group">
                    <label>Lokasyon</label>
                    <select id="location">
                        <option value="">Lokasyon se√ßin...</option>
                        <option value="√áerkezk√∂y">√áerkezk√∂y</option>
                        <option value="Velik√∂y">Velik√∂y</option>
                        <option value="Ankara">Ankara</option>
                        <option value="Bursa">Bursa</option>
                        <option value="Adana">Adana</option>
                        <option value="Eski≈üehir">Eski≈üehir</option>
                        <option value="Ultech1">Ultech1</option>
                        <option value="Ultech2">Ultech2</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Sertifika Dosyasƒ± *</label>
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">üìÑ</div>
                        <div class="upload-text">Fotoƒüraf veya PDF s√ºr√ºkleyin<br>veya tƒ±klayarak se√ßin</div>
                        <input type="file" id="fileInput" accept="image/*,.pdf" style="display:none">
                    </div>
                    <div id="filePreview"></div>
                </div>
                
                <div class="form-group">
                    <label>Not (Opsiyonel)</label>
                    <input type="text" id="notes" placeholder="Ek bilgi...">
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" id="saveBtn" onclick="saveCOA()" style="flex: 1;">üíæ Kaydet</button>
                    <button class="btn btn-secondary" id="cancelEditBtn" onclick="cancelEdit()" style="display: none;">‚ùå ƒ∞ptal</button>
                </div>
                
                <!-- Settings -->
                <div class="settings-section">
                    <h3>‚öôÔ∏è Google Sheets Baƒülantƒ±sƒ±</h3>
                    <input type="text" id="googleScriptUrl" placeholder="Google Apps Script URL" style="width:100%; margin-bottom:10px;">
                    <button class="btn btn-secondary btn-sm" onclick="connectGoogleSheets()">üîó Baƒülan</button>
                </div>
            </div>
            
            <!-- List -->
            <div class="card">
                <h2>üìã Sertifika Listesi</h2>
                
                <div class="filters">
                    <input type="text" id="searchInput" placeholder="üîç Ara (tedarik√ßi, hammadde, lot no...)">
                    
                    <div class="multiselect-container">
                        <div class="multiselect-header" id="supplierMultiselectHeader">
                            <span id="supplierMultiselectText">T√ºm Tedarik√ßiler</span>
                            <span>‚ñº</span>
                        </div>
                        <div class="multiselect-dropdown" id="supplierMultiselectDropdown">
                            <div class="multiselect-search">
                                <input type="text" id="supplierSearchInput" placeholder="Tedarik√ßi ara...">
                            </div>
                            <div id="supplierMultiselectOptions"></div>
                            <div class="multiselect-actions">
                                <button class="select-all" onclick="selectAllSuppliers()">‚úì T√ºm√ºn√º Se√ß</button>
                                <button class="clear-all" onclick="clearAllSuppliers()">‚úó Temizle</button>
                            </div>
                        </div>
                    </div>
                    
                    <input type="month" id="filterMonth">
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                    <button class="btn btn-danger btn-sm" onclick="deleteSelected()" id="deleteSelectedBtn" style="display: none;">
                        üóë Se√ßilenleri Sil (<span id="selectedCount">0</span>)
                    </button>
                </div>
                
                <div class="table-container">
                    <table id="coaTable">
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="headerCheckbox" onchange="toggleSelectAll()" style="cursor: pointer;"></th>
                                <th>Dosya</th>
                                <th>Tedarik√ßi</th>
                                <th>Hammadde Kodu</th>
                                <th>ƒ∞rsaliye Tarihi</th>
                                <th>ƒ∞rsaliye No</th>
                                <th>Lot No</th>
                                <th>Boyut</th>
                                <th>Lokasyon</th>
                                <th>ƒ∞≈ülem</th>
                            </tr>
                        </thead>
                        <tbody id="coaTableBody">
                        </tbody>
                    </table>
                    <div class="empty-state" id="emptyState">
                        <div class="icon">üì≠</div>
                        <p>Hen√ºz sertifika eklenmemi≈ü</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Image Modal -->
    <div class="modal" id="imageModal">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <div class="modal-content">
            <img id="modalImage" src="">
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <script>
        // ==================== Global Variables ====================
        let coaData = [];
        let suppliers = [];
        let materials = []; // Hammadde listesi
        let selectedSuppliers = new Set(); // Se√ßili tedarik√ßiler
        let googleScriptUrl = 'https://script.google.com/macros/s/AKfycbwGsK07SlGxg14sDI9P961nbdfYpYvVpNKWrYOrK_tp6S_OQz1M-cdErs0eT4QdKnPmmg/exec';
        let selectedFile = null;
        let selectedFileData = null;
        let editMode = false;
        let editingId = null;
        let selectedItems = new Set();
        
        // URL parametresinden tedarik√ßileri otomatik y√ºkle (Mobil link i√ßin)
        // NOT: URL √ßok uzun olduƒüu i√ßin (20,000+ karakter) WhatsApp ve √ßoƒüu tarayƒ±cƒ± keser
        // En iyi √ß√∂z√ºm: JSON dosyasƒ± indirip manuel y√ºklemek
        function loadSuppliersFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const suppliersData = urlParams.get('suppliers');
            
            console.log('üîç URL kontrol ediliyor...');
            console.log('URL parametresi var mƒ±?', suppliersData ? 'Evet' : 'Hayƒ±r');
            
            if (suppliersData) {
                try {
                    console.log('üîì Base64 decode ediliyor... (uzunluk: ' + suppliersData.length + ')');
                    
                    // URL √ßok uzunsa uyarƒ± ver
                    if (suppliersData.length < 1000) {
                        showToast('‚ö†Ô∏è URL verisi eksik g√∂r√ºn√ºyor. JSON dosyasƒ± y√ºkleyin.', 'warning', 5000);
                        return false;
                    }
                    
                    // Base64 decode ve parse et
                    const suppliers = JSON.parse(decodeURIComponent(atob(suppliersData)));
                    
                    console.log('‚úÖ Parse ba≈üarƒ±lƒ±. Tedarik√ßi sayƒ±sƒ±:', suppliers.length);
                    
                    if (Array.isArray(suppliers) && suppliers.length > 0) {
                        // localStorage'a kaydet
                        localStorage.setItem('supplierListForCOA', JSON.stringify(suppliers));
                        console.log('üíæ localStorage\'a kaydedildi');
                        
                        // Dropdown'ƒ± g√ºncelle
                        const select = document.getElementById('supplier');
                        // Mevcut se√ßenekleri temizle (placeholder hari√ß)
                        while (select.options.length > 1) {
                            select.remove(1);
                        }
                        // Tedarik√ßileri alfabetik sƒ±rala ve ekle
                        suppliers.sort().forEach(supplier => {
                            const option = document.createElement('option');
                            option.value = supplier;
                            option.textContent = supplier;
                            select.appendChild(option);
                        });
                        console.log('üîΩ Dropdown g√ºncellendi');
                        
                        // Ba≈üarƒ± mesajƒ± g√∂ster
                        showToast('‚úÖ ' + suppliers.length + ' tedarik√ßi mobilde y√ºklendi!', 'success', 4000);
                        
                        // URL'i temizle (parametreyi kaldƒ±r)
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                        console.log('üì± Mobil linkten tedarik√ßi y√ºklendi:', suppliers.length);
                        return true; // Ba≈üarƒ±lƒ±
                    }
                } catch (error) {
                    console.error('‚ùå URL\'den tedarik√ßi y√ºkleme hatasƒ±:', error);
                    showToast('‚ö†Ô∏è URL √ßok uzun veya bozuk. JSON dosyasƒ± y√ºkleyin.', 'warning', 5000);
                }
            }
            return false; // URL'de tedarik√ßi verisi yok
        }
        
        // ==================== Initialization ====================
        document.addEventListener('DOMContentLoaded', function() {
            // √ñnce URL'den tedarik√ßileri y√ºkle (mobil link varsa)
            loadSuppliersFromURL();
            
            // Set default date to today
            document.getElementById('deliveryDate').value = new Date().toISOString().split('T')[0];
            
            // Init upload area
            initUploadArea();
            
            // Init filters
            document.getElementById('searchInput').addEventListener('input', filterList);
            document.getElementById('filterMonth').addEventListener('change', filterList);
            
            // Init multiselect
            initSupplierMultiselect();
            
            // Load suppliers from localStorage (from index.html)
            loadSuppliers();
            
            // Load materials from localStorage
            loadMaterials();
            
            // ƒ∞lk y√ºklemede localStorage'dan y√ºkle (hƒ±zlƒ± ba≈ülangƒ±√ß)
            loadFromLocalStorage();
            if (coaData.length > 0) {
                renderTable();
                updateStats();
            }
            
            // Doƒüru URL - localStorage'daki eski URL'yi g√ºncelle
            const correctUrl = 'https://script.google.com/macros/s/AKfycbzlZBmNGbsQTDLBqGkDto3FWDb26Jc4lk2OhER5OhgmmU1QiPjgdi27goEVTbhqlDFIVw/exec';
            
            // Load saved URL and connect (delayed to ensure all functions are loaded)
            setTimeout(function() {
                let savedUrl = localStorage.getItem('google_script_url');
                
                // Eski veya yanlƒ±≈ü URL ise g√ºncelle
                if (!savedUrl || savedUrl.includes('AKfycbxKHsJ9pOyn2lq1KdmOgMlnOxyM0ga5ms8SrYcScGT70xCVNYxf8PWdId1jlrR8UqhvAw')) {
                    savedUrl = correctUrl;
                    localStorage.setItem('google_script_url', correctUrl);
                    console.log('‚úÖ URL g√ºncellendi:', correctUrl);
                }
                
                document.getElementById('googleScriptUrl').value = savedUrl;
                googleScriptUrl = savedUrl;
                connectGoogleSheets(true);
            }, 100);
        });
        
        // ==================== JSONP Helper ====================
        function jsonp(url, retries = 3) {
            return new Promise((resolve, reject) => {
                let currentRetry = 0;
                
                function tryConnect() {
                    const callbackName = 'cb_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                    const script = document.createElement('script');
                    
                    const timeout = setTimeout(() => {
                        cleanup();
                        if (currentRetry < retries) {
                            currentRetry++;
                            console.log(`Baƒülantƒ± denemesi ${currentRetry}/${retries}...`);
                            tryConnect();
                        } else {
                            reject(new Error('Timeout - T√ºm denemeler ba≈üarƒ±sƒ±z'));
                        }
                    }, 30000); // 30 saniye timeout (b√ºy√ºk dosyalar i√ßin)
                    
                    function cleanup() {
                        clearTimeout(timeout);
                        delete window[callbackName];
                        if (script.parentNode) script.parentNode.removeChild(script);
                    }
                    
                    window[callbackName] = (data) => {
                        cleanup();
                        resolve(data);
                    };
                    
                    script.onerror = () => {
                        cleanup();
                        if (currentRetry < retries) {
                            currentRetry++;
                            console.log(`Baƒülantƒ± hatasƒ±, deneme ${currentRetry}/${retries}...`);
                            setTimeout(tryConnect, 1000);
                        } else {
                            reject(new Error('Baƒülantƒ± kurulamadƒ±'));
                        }
                    };
                    
                    script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + callbackName;
                    document.body.appendChild(script);
                }
                
                tryConnect();
            });
        }
        
        // ==================== Google Sheets ====================
        async function connectGoogleSheets(silent = false) {
            const url = document.getElementById('googleScriptUrl').value.trim();
            if (!url) {
                if (!silent) showToast('‚ùå URL gerekli!', 'error');
                return;
            }
            
            // URL formatƒ±nƒ± kontrol et
            if (!url.includes('script.google.com') || !url.includes('/exec')) {
                if (!silent) showToast('‚ùå Ge√ßersiz Google Apps Script URL!', 'error');
                return;
            }
            
            document.getElementById('statusText').textContent = 'Baƒülanƒ±yor...';
            
            try {
                const data = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.timeout = 10000;
                    
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            try {
                                resolve(JSON.parse(xhr.responseText));
                            } catch(e) {
                                reject(new Error('JSON parse hatasƒ±'));
                            }
                        } else {
                            reject(new Error('HTTP ' + xhr.status));
                        }
                    };
                    
                    xhr.onerror = () => reject(new Error('Baƒülantƒ± hatasƒ±'));
                    xhr.ontimeout = () => reject(new Error('Zaman a≈üƒ±mƒ±'));
                    
                    xhr.open('POST', url, true);
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    
                    const formData = new URLSearchParams();
                    formData.append('action', 'test');
                    
                    xhr.send(formData.toString());
                });
                
                if (data.success) {
                    googleScriptUrl = url;
                    localStorage.setItem('google_script_url', url);
                    document.getElementById('statusDot').classList.add('connected');
                    document.getElementById('statusText').textContent = 'Google Sheets Baƒülƒ± ‚úì';
                    await loadFromGoogleSheets();
                    if (!silent) showToast('‚úÖ Baƒülantƒ± ba≈üarƒ±lƒ±! ' + (data.message || ''), 'success');
                    
                    // Bekleyen kayƒ±tlarƒ± senkronize et
                    setTimeout(() => syncPendingRecords(), 2000);
                } else {
                    throw new Error(data.error || 'Bilinmeyen hata');
                }
            } catch (error) {
                console.error('Google Sheets baƒülantƒ± hatasƒ±:', error);
                document.getElementById('statusDot').classList.remove('connected');
                document.getElementById('statusText').textContent = 'Baƒülantƒ± ba≈üarƒ±sƒ±z';
                loadFromLocalStorage();
                if (!silent) {
                    showToast('‚ùå Baƒülantƒ± hatasƒ±: ' + error.message, 'error');
                    showToast('üí° ƒ∞pucu: Apps Script\'i yeniden deploy edin', 'info');
                }
            }
            updateUI();
        }
        
        async function loadFromGoogleSheets() {
            try {
                console.log('Google Sheets\'ten veri y√ºkleniyor...');
                showToast('üîÑ Veriler y√ºkleniyor...', 'info');
                
                const data = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.timeout = 30000;
                    
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            try {
                                resolve(JSON.parse(xhr.responseText));
                            } catch(e) {
                                reject(new Error('JSON parse hatasƒ±'));
                            }
                        } else {
                            reject(new Error('HTTP ' + xhr.status));
                        }
                    };
                    
                    xhr.onerror = () => reject(new Error('Baƒülantƒ± hatasƒ±'));
                    xhr.ontimeout = () => reject(new Error('Zaman a≈üƒ±mƒ±'));
                    
                    xhr.open('POST', googleScriptUrl, true);
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    
                    const formData = new URLSearchParams();
                    formData.append('action', 'getAllCOA');
                    formData.append('includeFileData', 'true');
                    
                    xhr.send(formData.toString());
                });
                
                if (data && data.success) {
                    // Kayƒ±tlarƒ± al (fileData dahil)
                    coaData = (data.data || []).map(record => {
                        return {
                            id: record.id,
                            supplier: record.supplier,
                            materialCode: record.materialCode,
                            deliveryDate: record.deliveryDate,
                            deliveryNo: record.deliveryNo || '',
                            lotNumber: record.lotNumber || '',
                            location: record.location || '',
                            notes: record.notes || '',
                            fileName: record.fileName || '',
                            fileType: record.fileType || '',
                            fileUrl: record.fileUrl || '',
                            fileData: record.fileData || '', // Dosya verisi dahil
                            fileSize: record.fileSize || 0, // Dosya boyutu (bytes)
                            driveFileId: record.driveFileId || '',
                            createdAt: record.createdAt || '',
                            updatedAt: record.updatedAt || ''
                        };
                    });
                    
                    console.log('Y√ºklenen kayƒ±t sayƒ±sƒ±:', coaData.length);
                    const withFiles = coaData.filter(r => r.fileData).length;
                    const withFileSize = coaData.filter(r => r.fileSize).length;
                    console.log('Dosyalƒ± kayƒ±t sayƒ±sƒ±:', withFiles);
                    console.log('fileSize bilgisi olan:', withFileSize);
                    
                    // ƒ∞lk kayƒ±ttan √∂rnek g√∂ster
                    if (coaData.length > 0) {
                        console.log('ƒ∞lk kayƒ±t √∂rneƒüi:', {
                            id: coaData[0].id,
                            fileName: coaData[0].fileName,
                            fileSize: coaData[0].fileSize,
                            hasFileData: !!coaData[0].fileData
                        });
                    }
                    
                    // Yerel yedek olarak da kaydet
                    saveToLocalStorage();
                    
                    // Tabloyu g√ºncelle
                    renderTable();
                    updateUI();
                    
                    // Sheets'ten istatistikleri de y√ºkle
                    loadStatsFromGoogleSheets();
                    
                    showToast('‚úÖ ' + coaData.length + ' kayƒ±t y√ºklendi (' + withFiles + ' dosyalƒ±)', 'success');
                } else {
                    console.error('Veri y√ºkleme hatasƒ±:', data?.error);
                    loadFromLocalStorage();
                    renderTable();
                    showToast('‚ö†Ô∏è Sheets hatasƒ±, yerel veriler kullanƒ±lƒ±yor', 'warning');
                }
            } catch (error) {
                console.error('Y√ºkleme hatasƒ±:', error);
                // Yerel veriden y√ºkle
                loadFromLocalStorage();
                renderTable();
                showToast('‚ö†Ô∏è √áevrimdƒ±≈üƒ± mod - yerel veriler kullanƒ±lƒ±yor', 'warning');
            }
        }
        
        async function loadStatsFromGoogleSheets() {
            if (!googleScriptUrl) return;
            
            try {
                const url = googleScriptUrl + '?action=getStats';
                const result = await jsonp(url);
                
                if (result && result.success && result.data) {
                    const stats = result.data;
                    
                    // Toplam dosya boyutunu g√ºncelle
                    if (stats.totalFileSizeMB !== undefined) {
                        document.getElementById('statTotalSize').textContent = stats.totalFileSizeMB + ' MB';
                        console.log('üìä Sheets\'ten dosya boyutu g√ºncellendi:', stats.totalFileSizeMB, 'MB');
                    }
                }
            } catch (error) {
                console.error('ƒ∞statistik y√ºkleme hatasƒ±:', error);
            }
        }
        
        async function saveToGoogleSheets(record) {
            try {
                showToast('üì§ Kaydediliyor...', 'info');
                
                let fileUrl = '';
                let driveFileId = '';
                let fileSize = 0;
                
                // Dosya varsa Drive'a y√ºkle
                if (record.fileData && record.fileName) {
                    console.log('Dosya Drive\'a y√ºkleniyor...', record.fileName);
                    showToast('‚òÅÔ∏è Google Drive\'a y√ºkleniyor...', 'info');
                    
                    try {
                        // Y√ºksek kalite - 250KB (net okunabilir)
                        const compressedData = await compressForSheets(record.fileData, 250);
                        console.log('Sƒ±kƒ±≈ütƒ±rƒ±lmƒ±≈ü boyut:', Math.round(compressedData.length / 1024), 'KB');
                        
                        // XMLHttpRequest POST (b√ºy√ºk veri i√ßin)
                        const uploadResult = await new Promise((resolve, reject) => {
                            const xhr = new XMLHttpRequest();
                            xhr.timeout = 60000; // 60 saniye
                            
                            xhr.onload = function() {
                                if (xhr.status === 200) {
                                    try {
                                        const result = JSON.parse(xhr.responseText);
                                        resolve(result);
                                    } catch(e) {
                                        reject(new Error('JSON parse hatasƒ±'));
                                    }
                                } else {
                                    reject(new Error('HTTP ' + xhr.status));
                                }
                            };
                            
                            xhr.onerror = () => reject(new Error('Baƒülantƒ± hatasƒ±'));
                            xhr.ontimeout = () => reject(new Error('Zaman a≈üƒ±mƒ±'));
                            
                            xhr.open('POST', googleScriptUrl, true);
                            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                            
                            const formData = new URLSearchParams();
                            formData.append('action', 'uploadFile');
                            formData.append('fileData', compressedData);
                            formData.append('fileName', record.fileName);
                            formData.append('mimeType', record.fileType || 'image/jpeg');
                            
                            xhr.send(formData.toString());
                        });
                        
                        console.log('Drive upload sonucu:', uploadResult);
                        
                        if (uploadResult && uploadResult.success) {
                            fileUrl = uploadResult.viewUrl || uploadResult.directUrl;
                            driveFileId = uploadResult.fileId;
                            fileSize = uploadResult.fileSize || 0;
                            showToast('‚úÖ Dosya Drive\'a y√ºklendi!', 'success');
                        } else {
                            console.error('Drive upload hatasƒ±:', uploadResult?.error);
                            throw new Error(uploadResult?.error || 'Dosya Drive\'a y√ºklenemedi');
                        }
                    } catch (uploadErr) {
                        console.error('Drive upload hatasƒ±:', uploadErr);
                        throw new Error('Drive y√ºkleme hatasƒ±: ' + uploadErr.message);
                    }
                }
                
                // Kayƒ±t verisini hazƒ±rla
                const saveData = {
                    id: record.id,
                    supplier: record.supplier,
                    materialCode: record.materialCode,
                    deliveryDate: record.deliveryDate,
                    deliveryNo: record.deliveryNo || '',
                    lotNumber: record.lotNumber || '',
                    location: record.location || '',
                    notes: record.notes || '',
                    fileName: record.fileName || '',
                    fileType: record.fileType || '',
                    fileUrl: fileUrl,
                    driveFileId: driveFileId,
                    fileData: '', // Sheets'e base64 koymuyoruz
                    fileSize: fileSize || record.fileSize || 0, // Dosya boyutu
                    createdAt: record.createdAt || new Date().toISOString()
                };
                
                // XMLHttpRequest POST ile metadata g√∂nder
                console.log('Metadata kaydediliyor...');
                
                const result = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.timeout = 30000;
                    
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            try {
                                resolve(JSON.parse(xhr.responseText));
                            } catch(e) {
                                reject(new Error('JSON parse hatasƒ±'));
                            }
                        } else {
                            reject(new Error('HTTP ' + xhr.status));
                        }
                    };
                    
                    xhr.onerror = () => reject(new Error('Baƒülantƒ± hatasƒ±'));
                    xhr.ontimeout = () => reject(new Error('Zaman a≈üƒ±mƒ±'));
                    
                    xhr.open('POST', googleScriptUrl, true);
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    
                    const formData = new URLSearchParams();
                    formData.append('action', 'addCOA');
                    formData.append('data', JSON.stringify(saveData));
                    
                    xhr.send(formData.toString());
                });
                
                console.log('Kayƒ±t sonucu:', result);
                
                if (!result || !result.success) {
                    throw new Error(result?.error || 'Kayƒ±t olu≈üturulamadƒ±');
                }
                
                showToast('‚úÖ Kayƒ±t ve dosya ba≈üarƒ±yla Drive\'a eklendi!', 'success');
                return true;
                
            } catch (error) {
                console.error('Kaydetme hatasƒ±:', error);
                showToast('‚ùå Hata: ' + error.message, 'error');
                return false;
            }
        }
        
        // Dosyayƒ± Google Drive'a chunk'lar halinde y√ºkle
        async function uploadToDriveChunked(fileData, fileName, mimeType) {
            const CHUNK_SIZE = 5000; // 5KB per chunk (URL-safe ve hƒ±zlƒ±)
            const chunks = [];
            
            // Dosyayƒ± par√ßala
            for (let i = 0; i < fileData.length; i += CHUNK_SIZE) {
                chunks.push(fileData.substring(i, i + CHUNK_SIZE));
            }
            
            console.log('Drive upload - Toplam chunk sayƒ±sƒ±:', chunks.length, '(her biri ~5KB)');
            
            try {
                // 1. Upload ba≈ülat
                const initUrl = googleScriptUrl + 
                    '?action=initUpload' +
                    '&fileName=' + encodeURIComponent(fileName) +
                    '&mimeType=' + encodeURIComponent(mimeType || 'image/jpeg') +
                    '&totalChunks=' + chunks.length +
                    '&totalSize=' + fileData.length;
                
                console.log('Init URL uzunluƒüu:', initUrl.length);
                const initResult = await jsonp(initUrl);
                
                if (!initResult || !initResult.success) {
                    console.error('Upload init hatasƒ±:', initResult?.error);
                    return { success: false, error: initResult?.error || 'Init hatasƒ±' };
                }
                
                const uploadId = initResult.uploadId;
                console.log('Upload ba≈ülatƒ±ldƒ±, ID:', uploadId);
                
                // 2. Chunk'larƒ± g√∂nder
                for (let i = 0; i < chunks.length; i++) {
                    // Her 10 chunk'ta bir progress g√∂ster
                    if (i % 10 === 0 || i === chunks.length - 1) {
                        showToast('üì§ Drive\'a y√ºkleniyor... ' + Math.round((i + 1) / chunks.length * 100) + '%', 'info');
                    }
                    
                    const chunkUrl = googleScriptUrl + 
                        '?action=uploadChunk' +
                        '&uploadId=' + encodeURIComponent(uploadId) +
                        '&chunkIndex=' + i +
                        '&totalChunks=' + chunks.length +
                        '&chunk=' + encodeURIComponent(chunks[i]);
                    
                    // Retry mekanizmasƒ±
                    let chunkResult = null;
                    let retryCount = 0;
                    const maxRetries = 3;
                    
                    while (retryCount < maxRetries) {
                        try {
                            chunkResult = await jsonp(chunkUrl);
                            if (chunkResult && chunkResult.success) {
                                break; // Ba≈üarƒ±lƒ±
                            }
                        } catch (e) {
                            console.log('Chunk', i, 'retry', retryCount + 1);
                        }
                        retryCount++;
                        await new Promise(r => setTimeout(r, 500)); // 500ms bekle
                    }
                    
                    if (!chunkResult || !chunkResult.success) {
                        const errorMsg = chunkResult?.error || 'Bilinmeyen hata';
                        console.error('Chunk hatasƒ±:', i, errorMsg);
                        return { success: false, error: 'Chunk ' + i + ' hatasƒ±: ' + errorMsg };
                    }
                    
                    // Her 20 chunk'ta bir log
                    if (i % 20 === 0 || i === chunks.length - 1) {
                        console.log('Chunk g√∂nderildi:', i + 1, '/', chunks.length);
                    }
                    
                    // Rate limiting - daha kƒ±sa bekle (200ms)
                    if (i < chunks.length - 1) {
                        await new Promise(r => setTimeout(r, 200));
                    }
                }
                
                // 3. Upload tamamla
                showToast('üì§ Dosya birle≈ütiriliyor...', 'info');
                const finalizeUrl = googleScriptUrl + 
                    '?action=finalizeUpload' +
                    '&uploadId=' + encodeURIComponent(uploadId) +
                    '&fileName=' + encodeURIComponent(fileName) +
                    '&mimeType=' + encodeURIComponent(mimeType || 'image/jpeg');
                
                const finalResult = await jsonp(finalizeUrl);
                
                if (!finalResult || !finalResult.success) {
                    console.error('Finalize hatasƒ±:', finalResult?.error);
                    return { success: false, error: finalResult?.error || 'Finalize hatasƒ±' };
                }
                
                console.log('Upload tamamlandƒ±:', finalResult);
                return finalResult;
                
            } catch (error) {
                console.error('Chunk upload hatasƒ±:', error);
                return { success: false, error: error.message };
            }
        }
        
        // Eski fonksiyon - Sheets'e chunk (artƒ±k kullanƒ±lmƒ±yor)
        async function uploadFileInChunks(recordId, fileData) {
            const CHUNK_SIZE = 1500;
            const chunks = [];
            
            // Dosyayƒ± par√ßala
            for (let i = 0; i < fileData.length; i += CHUNK_SIZE) {
                chunks.push(fileData.substring(i, i + CHUNK_SIZE));
            }
            
            console.log('Toplam chunk sayƒ±sƒ±:', chunks.length);
            
            // Her chunk'ƒ± sƒ±rayla g√∂nder
            for (let i = 0; i < chunks.length; i++) {
                showToast('üì§ Dosya y√ºkleniyor... ' + Math.round((i + 1) / chunks.length * 100) + '%', 'info');
                
                // URL'yi manuel olu≈ütur (encodeURIComponent ile)
                const chunkUrl = googleScriptUrl + 
                    '?action=appendFileData' +
                    '&id=' + encodeURIComponent(recordId) +
                    '&chunk=' + encodeURIComponent(chunks[i]) +
                    '&chunkIndex=' + i +
                    '&totalChunks=' + chunks.length;
                
                console.log('Chunk URL uzunluƒüu:', chunkUrl.length);
                
                try {
                    const chunkResult = await jsonp(chunkUrl);
                    
                    if (!chunkResult || !chunkResult.success) {
                        console.error('Chunk hatasƒ±:', i, chunkResult?.error);
                        return false;
                    }
                    
                    console.log('Chunk g√∂nderildi:', i + 1, '/', chunks.length);
                } catch (e) {
                    console.error('Chunk g√∂nderme hatasƒ±:', i, e);
                    return false;
                }
                
                // Rate limiting - √ßok hƒ±zlƒ± istek atmayalƒ±m
                if (i < chunks.length - 1) {
                    await new Promise(r => setTimeout(r, 200));
                }
            }
            
            return true;
        }
        
        // Dosya y√ºkleme fonksiyonu - birden fazla servis dener
        async function uploadToImgBB(base64Data) {
            // Base64 verisi hazƒ±rla
            let imageData = base64Data;
            if (imageData.includes(',')) {
                imageData = imageData.split(',')[1];
            }
            
            // 1. √ñnce imgbb.com dene (√ºcretsiz API)
            try {
                console.log('imgBB\'ye y√ºkleniyor...');
                const formData = new FormData();
                formData.append('image', imageData);
                
                // √úcretsiz API key (sƒ±nƒ±rlƒ± kullanƒ±m)
                const response = await fetch('https://api.imgbb.com/1/upload?key=00d1452b3d2add1cfe46862457505d88', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success && result.data && result.data.url) {
                    console.log('imgBB ba≈üarƒ±lƒ±:', result.data.url);
                    return {
                        success: true,
                        url: result.data.url
                    };
                }
            } catch (e) {
                console.warn('imgBB hatasƒ±:', e.message);
            }
            
            // 2. freeimage.host dene
            try {
                console.log('freeimage.host\'a y√ºkleniyor...');
                const formData = new FormData();
                formData.append('source', imageData);
                formData.append('type', 'base64');
                formData.append('action', 'upload');
                
                const response = await fetch('https://freeimage.host/api/1/upload?key=6d207e02198a847aa98d0a2a901485a5', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.status_code === 200 && result.image && result.image.url) {
                    console.log('freeimage ba≈üarƒ±lƒ±:', result.image.url);
                    return {
                        success: true,
                        url: result.image.url
                    };
                }
            } catch (e) {
                console.warn('freeimage hatasƒ±:', e.message);
            }
            
            // T√ºm servisler ba≈üarƒ±sƒ±z - dosya yerel olarak saklanacak
            console.log('T√ºm upload servisleri ba≈üarƒ±sƒ±z, dosya yerel olarak saklanacak');
            return { success: false, error: 'Upload servisleri kullanƒ±lamƒ±yor' };
        }
        
        // Data URL'i daha fazla sƒ±kƒ±≈ütƒ±r
        async function compressDataUrl(dataUrl, maxSizeKB) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    let width = img.width;
                    let height = img.height;
                    const maxSize = maxSizeKB * 1024;
                    
                    // Boyutu k√º√ß√ºlt
                    const maxDim = 800;
                    if (width > maxDim || height > maxDim) {
                        if (width > height) {
                            height = Math.round(height * maxDim / width);
                            width = maxDim;
                        } else {
                            width = Math.round(width * maxDim / height);
                            height = maxDim;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, width, height);
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    let quality = 0.5;
                    let result = canvas.toDataURL('image/jpeg', quality);
                    
                    while (result.length > maxSize && quality > 0.1) {
                        quality -= 0.1;
                        result = canvas.toDataURL('image/jpeg', quality);
                    }
                    
                    // Hala b√ºy√ºkse daha da k√º√ß√ºlt
                    if (result.length > maxSize) {
                        const scale = Math.sqrt(maxSize / result.length) * 0.8;
                        canvas.width = Math.round(width * scale);
                        canvas.height = Math.round(height * scale);
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        result = canvas.toDataURL('image/jpeg', 0.4);
                    }
                    
                    resolve(result);
                };
                img.src = dataUrl;
            });
        }
        
        // Sheets i√ßin √∂zel sƒ±kƒ±≈ütƒ±rma (max 15KB hedef - URL limiti i√ßin)
        async function compressForSheets(dataUrl, maxSizeKB = 250) {
            return new Promise((resolve, reject) => {
                // PDF ise thumbnail olarak d√∂n√º≈üt√ºr
                if (dataUrl.includes('application/pdf')) {
                    console.warn('PDF dosyasƒ± - sadece meta bilgisi kaydedilecek');
                    resolve('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2YwZjBmMCIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iIGZvbnQtc2l6ZT0iMjQiPvCfk4Q8L3RleHQ+PC9zdmc+');
                    return;
                }
                
                const img = new Image();
                img.onerror = () => {
                    console.error('Resim y√ºklenemedi');
                    resolve('');
                };
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    let width = img.width;
                    let height = img.height;
                    const maxSize = maxSizeKB * 1024;
                    
                    // Hedef boyuta g√∂re ba≈ülangƒ±√ß boyutu ayarla
                    let maxDim = maxSizeKB >= 200 ? 2000 : (maxSizeKB >= 100 ? 1600 : (maxSizeKB >= 50 ? 1000 : 600));
                    
                    if (width > maxDim || height > maxDim) {
                        if (width > height) {
                            height = Math.round(height * maxDim / width);
                            width = maxDim;
                        } else {
                            width = Math.round(width * maxDim / height);
                            height = maxDim;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, width, height);
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Kalite ba≈ülangƒ±cƒ±
                    let quality = maxSizeKB >= 200 ? 0.90 : (maxSizeKB >= 100 ? 0.85 : (maxSizeKB >= 50 ? 0.7 : 0.6));
                    let result = canvas.toDataURL('image/jpeg', quality);
                    
                    // Boyut b√ºy√ºkse kaliteyi d√º≈ü√ºr
                    while (result.length > maxSize && quality > 0.3) {
                        quality -= 0.1;
                        result = canvas.toDataURL('image/jpeg', quality);
                    }
                    
                    // Hala b√ºy√ºkse boyutu k√º√ß√ºlt
                    if (result.length > maxSize) {
                        maxDim = Math.round(maxDim * 0.7);
                        if (img.width > img.height) {
                            canvas.width = maxDim;
                            canvas.height = Math.round(maxDim * img.height / img.width);
                        } else {
                            canvas.height = maxDim;
                            canvas.width = Math.round(maxDim * img.width / img.height);
                        }
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        result = canvas.toDataURL('image/jpeg', 0.5);
                    }
                    
                    // Hala b√ºy√ºkse daha da k√º√ß√ºlt
                    if (result.length > maxSize) {
                        maxDim = Math.round(maxDim * 0.7);
                        if (img.width > img.height) {
                            canvas.width = maxDim;
                            canvas.height = Math.round(maxDim * img.height / img.width);
                        } else {
                            canvas.height = maxDim;
                            canvas.width = Math.round(maxDim * img.width / img.height);
                        }
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        result = canvas.toDataURL('image/jpeg', 0.4);
                    }
                    
                    console.log('Sƒ±kƒ±≈ütƒ±rma sonucu:', Math.round(result.length/1024), 'KB, boyut:', canvas.width, 'x', canvas.height, 'kalite:', quality);
                    resolve(result);
                };
                img.src = dataUrl;
            });
        }
        
        // Bekleyen kayƒ±tlarƒ± senkronize et
        async function syncPendingRecords() {
            if (!googleScriptUrl) return;
            
            const pending = coaData.filter(r => r.pending);
            if (pending.length === 0) return;
            
            console.log('Bekleyen kayƒ±t sayƒ±sƒ±:', pending.length);
            showToast('üîÑ ' + pending.length + ' bekleyen kayƒ±t senkronize ediliyor...', 'info');
            
            let successCount = 0;
            let failCount = 0;
            
            for (const record of pending) {
                try {
                    // Dosyayƒ± sƒ±kƒ±≈ütƒ±r ve Sheets'e kaydet
                    if (record.fileData) {
                        try {
                            record.fileData = await compressForSheets(record.fileData, 40);
                        } catch (e) {
                            console.warn('Sƒ±kƒ±≈ütƒ±rma hatasƒ±, orijinal kullanƒ±lƒ±yor');
                        }
                    }
                    
                    delete record.pending;
                    
                    // Sheets'e kaydet (fileData dahil)
                    const params = new URLSearchParams();
                    params.append('action', 'addCOA');
                    params.append('data', JSON.stringify(record));
                    
                    const result = await jsonp(googleScriptUrl + '?' + params.toString());
                    if (result && result.success) {
                        successCount++;
                    } else {
                        failCount++;
                        record.pending = true; // Ba≈üarƒ±sƒ±zsa tekrar beklemede yap
                    }
                    
                    console.log('Senkronize edildi:', record.id);
                } catch (e) {
                    failCount++;
                    record.pending = true;
                    console.error('Senkronizasyon hatasƒ±:', record.id, e);
                }
            }
            
            saveToLocalStorage();
            
            if (failCount === 0) {
                showToast('‚úÖ ' + successCount + ' kayƒ±t senkronize edildi', 'success');
            } else {
                showToast('‚ö†Ô∏è ' + successCount + ' ba≈üarƒ±lƒ±, ' + failCount + ' ba≈üarƒ±sƒ±z', 'warning');
            }
        }
        
        async function deleteFromGoogleSheets(id) {
            try {
                const params = new URLSearchParams();
                params.append('action', 'deleteCOA');
                params.append('id', id);
                
                const result = await jsonp(googleScriptUrl + '?' + params.toString());
                return result.success;
            } catch (error) {
                return false;
            }
        }
        
        async function updateToGoogleSheets(record) {
            try {
                // fileData √ßok b√ºy√ºkse g√∂nderme (zaten Drive'da var)
                const recordToSend = { ...record };
                
                // Eƒüer fileData √ßok b√ºy√ºkse (>50KB) g√∂nderme
                if (recordToSend.fileData && recordToSend.fileData.length > 50000) {
                    console.log('fileData √ßok b√ºy√ºk, g√∂nderilmiyor (Drive\'da mevcut)');
                    delete recordToSend.fileData;
                }
                
                // JSONP ile POST g√∂nder (fetch yerine)
                const updateUrl = googleScriptUrl + 
                    '?action=updateCOA' +
                    '&id=' + encodeURIComponent(record.id) +
                    '&data=' + encodeURIComponent(JSON.stringify(recordToSend));
                
                console.log('Update URL olu≈üturuldu, uzunluk:', updateUrl.length);
                
                const result = await jsonp(updateUrl);
                
                if (result && result.success) {
                    console.log('Google Sheets g√ºncellendi:', record.id);
                    return true;
                } else {
                    console.error('G√ºncelleme hatasƒ±:', result?.error);
                    showToast('‚ö†Ô∏è Google Sheets g√ºncellenemedi: ' + (result?.error || 'Bilinmeyen hata'), 'error');
                    return false;
                }
            } catch (error) {
                console.error('updateToGoogleSheets hatasƒ±:', error);
                showToast('‚ö†Ô∏è Google Sheets baƒülantƒ± hatasƒ±: ' + error.message, 'error');
                return false;
            }
        }
        
        // ==================== Local Storage ====================
        function loadFromLocalStorage() {
            const saved = localStorage.getItem('coa_arsiv_data');
            if (saved) {
                coaData = JSON.parse(saved);
                console.log('localStorage\'dan y√ºklendi:', coaData.length, 'kayƒ±t');
            }
        }
        
        function saveToLocalStorage() {
            localStorage.setItem('coa_arsiv_data', JSON.stringify(coaData));
        }
        
        // ==================== Suppliers ====================
        function loadSuppliers() {
            let supplierNames = [];
            
            // √ñncelik 1: index.html'den kaydedilen tedarik√ßi listesi
            const supplierListForCOA = localStorage.getItem('supplierListForCOA');
            if (supplierListForCOA) {
                try {
                    supplierNames = JSON.parse(supplierListForCOA);
                    console.log('Tedarik√ßi listesi y√ºklendi (supplierListForCOA):', supplierNames.length);
                } catch(e) {
                    console.error('supplierListForCOA parse hatasƒ±:', e);
                }
            }
            
            // √ñncelik 2: supplierStatusMap'ten al
            if (supplierNames.length === 0) {
                const supplierMap = localStorage.getItem('supplierStatusMap');
                if (supplierMap) {
                    try {
                        const map = JSON.parse(supplierMap);
                        supplierNames = Object.keys(map);
                        console.log('Tedarik√ßi listesi y√ºklendi (supplierStatusMap):', supplierNames.length);
                    } catch(e) {}
                }
            }
            
            // √ñncelik 3: supplierInfoMap'ten al
            if (supplierNames.length === 0) {
                const supplierInfo = localStorage.getItem('supplierInfoMap');
                if (supplierInfo) {
                    try {
                        const info = JSON.parse(supplierInfo);
                        supplierNames = Object.keys(info);
                        console.log('Tedarik√ßi listesi y√ºklendi (supplierInfoMap):', supplierNames.length);
                    } catch(e) {}
                }
            }
            
            // √ñncelik 4: Default tedarik√ßi listesi (Excel y√ºklenmediyse)
            if (supplierNames.length === 0) {
                supplierNames = getDefaultSuppliers();
                console.log('Default tedarik√ßi listesi y√ºklendi:', supplierNames.length);
            }
            
            // Mevcut COA verilerinden de ekle
            coaData.forEach(c => {
                if (c.supplier && !supplierNames.includes(c.supplier)) {
                    supplierNames.push(c.supplier);
                }
            });
            
            suppliers = supplierNames.sort();
            updateSupplierDropdowns();
            
            if (suppliers.length === 0) {
                console.warn('Tedarik√ßi listesi bo≈ü! √ñnce Ana Sayfada Excel y√ºkleyin.');
            }
        }
        
        // JSON dosyasƒ±ndan tedarik√ßi listesi y√ºkle
        function loadSupplierJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showToast('üìÇ JSON dosyasƒ± okunuyor...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    
                    // Validasyon
                    if (!jsonData.suppliers || !Array.isArray(jsonData.suppliers)) {
                        showToast('‚ùå Ge√ßersiz JSON formatƒ±!', 'error');
                        return;
                    }
                    
                    // Tedarik√ßi listesini g√ºncelle
                    const supplierNames = jsonData.suppliers.filter(n => n && n.trim());
                    
                    if (supplierNames.length === 0) {
                        showToast('‚ö†Ô∏è JSON dosyasƒ±nda tedarik√ßi bulunamadƒ±!', 'warning');
                        return;
                    }
                    
                    // localStorage'a kaydet
                    localStorage.setItem('supplierListForCOA', JSON.stringify(supplierNames));
                    
                    // Listeyi yenile
                    suppliers = supplierNames.sort();
                    updateSupplierDropdowns();
                    
                    showToast(`‚úÖ ${supplierNames.length} tedarik√ßi y√ºklendi!`, 'success');
                    console.log('‚úÖ JSON\'dan y√ºklendi:', supplierNames.length, 'tedarik√ßi');
                    console.log('ƒ∞lk 5:', supplierNames.slice(0, 5));
                    
                } catch (error) {
                    console.error('JSON okuma hatasƒ±:', error);
                    showToast('‚ùå JSON okuma hatasƒ±: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
            
            // Input'u temizle (aynƒ± dosyayƒ± tekrar y√ºkleyebilmek i√ßin)
            event.target.value = '';
        }
        
        // Excel dosyasƒ±ndan tedarik√ßi ve hammadde listesi y√ºkle
        function loadExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showToast('üìä Excel dosyasƒ± okunuyor...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // ƒ∞lk sayfayƒ± al
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    if (jsonData.length < 2) {
                        showToast('‚ö†Ô∏è Excel dosyasƒ± bo≈ü!', 'warning');
                        return;
                    }
                    
                    // Header satƒ±rƒ±nƒ± bul
                    const headers = jsonData[0];
                    
                    // S√ºtun indekslerini bul
                    let cariAdiIndex = -1;
                    let stokKoduIndex = -1;
                    let stokAdiIndex = -1;
                    
                    headers.forEach((header, index) => {
                        const h = String(header).trim().toLowerCase();
                        if (h === 'cari adƒ±' || h === 'cari adi' || h === 'cariadƒ±' || h === 'cariadi') {
                            cariAdiIndex = index;
                        }
                        if (h === 'stok kodu' || h === 'stokkodu') {
                            stokKoduIndex = index;
                        }
                        if (h === 'stok adƒ±' || h === 'stok adi' || h === 'stokadƒ±' || h === 'stokadi') {
                            stokAdiIndex = index;
                        }
                    });
                    
                    // Kontrol
                    if (cariAdiIndex === -1 || stokKoduIndex === -1 || stokAdiIndex === -1) {
                        showToast('‚ùå Excel\'de gerekli s√ºtunlar bulunamadƒ±! (Cari Adƒ±, Stok Kodu, Stok Adƒ±)', 'error');
                        console.error('Bulunan headers:', headers);
                        console.error('Cari Adƒ± indeks:', cariAdiIndex, 'Stok Kodu indeks:', stokKoduIndex, 'Stok Adƒ± indeks:', stokAdiIndex);
                        return;
                    }
                    
                    // Verileri topla
                    const supplierSet = new Set();
                    const materialMap = new Map(); // stokKodu -> {code, name, suppliers: []}
                    
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        
                        // Tedarik√ßi adƒ± (tekrarlayanlarƒ± alma)
                        const cariAdi = row[cariAdiIndex];
                        if (cariAdi && String(cariAdi).trim()) {
                            supplierSet.add(String(cariAdi).trim());
                        }
                        
                        // Hammadde kodu ve adƒ± (tekrarlayan kodlarƒ± alma)
                        const stokKodu = row[stokKoduIndex];
                        const stokAdi = row[stokAdiIndex];
                        if (stokKodu && String(stokKodu).trim() && stokAdi && String(stokAdi).trim()) {
                            const code = String(stokKodu).trim();
                            const name = String(stokAdi).trim();
                            const supplier = cariAdi ? String(cariAdi).trim() : null;
                            
                            // Hammadde-tedarik√ßi ili≈ükisini kaydet
                            if (!materialMap.has(code)) {
                                materialMap.set(code, { code, name, suppliers: [] });
                            }
                            
                            // Bu tedarik√ßiyi hammaddenin supplier listesine ekle
                            if (supplier && !materialMap.get(code).suppliers.includes(supplier)) {
                                materialMap.get(code).suppliers.push(supplier);
                            }
                        }
                    }
                    
                    // Array'lere √ßevir
                    const supplierArray = Array.from(supplierSet).sort();
                    const materialArray = Array.from(materialMap.values());
                    
                    if (supplierArray.length === 0 && materialArray.length === 0) {
                        showToast('‚ö†Ô∏è Excel dosyasƒ±nda veri bulunamadƒ±!', 'warning');
                        return;
                    }
                    
                    // LocalStorage'a kaydet
                    if (supplierArray.length > 0) {
                        localStorage.setItem('supplierListForCOA', JSON.stringify(supplierArray));
                        suppliers = supplierArray;
                        updateSupplierDropdowns();
                    }
                    
                    if (materialArray.length > 0) {
                        saveMaterials(materialArray);
                        materials = materialArray;
                        updateMaterialDropdown();
                    }
                    
                    showToast(`‚úÖ Excel y√ºklendi! ${supplierArray.length} tedarik√ßi, ${materialArray.length} hammadde`, 'success');
                    console.log('‚úÖ Excel\'den y√ºklendi:');
                    console.log('- Tedarik√ßiler:', supplierArray.length);
                    console.log('- Hammaddeler:', materialArray.length);
                    console.log('ƒ∞lk 3 tedarik√ßi:', supplierArray.slice(0, 3));
                    console.log('ƒ∞lk 3 hammadde:', materialArray.slice(0, 3));
                    
                } catch (error) {
                    console.error('Excel okuma hatasƒ±:', error);
                    showToast('‚ùå Excel okuma hatasƒ±: ' + error.message, 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
            
            // Input'u temizle (aynƒ± dosyayƒ± tekrar y√ºkleyebilmek i√ßin)
            event.target.value = '';
        }
        
        function updateSupplierDropdowns() {
            const datalist = document.getElementById('supplierList');
            const filter = document.getElementById('filterSupplier');
            const countSpan = document.getElementById('supplierCount');
            
            // Clear existing options
            datalist.innerHTML = '';
            filter.innerHTML = '<option value="">T√ºm Tedarik√ßiler</option>';
            
            suppliers.forEach(s => {
                datalist.innerHTML += `<option value="${s}">`;
                filter.innerHTML += `<option value="${s}">${s}</option>`;
            });
            
            // Tedarik√ßi sayƒ±sƒ±nƒ± g√∂ster
            if (countSpan) {
                if (suppliers.length === 0) {
                    countSpan.innerHTML = '(‚ö†Ô∏è Liste bo≈ü - Ana sayfada Excel y√ºkleyin)';
                    countSpan.style.color = '#f44336';
                } else {
                    countSpan.innerHTML = `(üìä ${suppliers.length} tedarik√ßi)`;
                    countSpan.style.color = '#4CAF50';
                }
            }
        }
        
        // ==================== Multiselect ====================
        function initSupplierMultiselect() {
            const header = document.getElementById('supplierMultiselectHeader');
            const dropdown = document.getElementById('supplierMultiselectDropdown');
            const searchInput = document.getElementById('supplierSearchInput');
            
            // Toggle dropdown
            header.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('active');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.multiselect-container')) {
                    dropdown.classList.remove('active');
                }
            });
            
            // Search suppliers
            searchInput.addEventListener('input', (e) => {
                e.stopPropagation();
                const search = e.target.value.toLowerCase();
                const options = document.querySelectorAll('.multiselect-option');
                options.forEach(opt => {
                    const text = opt.textContent.toLowerCase();
                    opt.style.display = text.includes(search) ? 'flex' : 'none';
                });
            });
        }
        
        function updateSupplierDropdowns() {
            const optionsContainer = document.getElementById('supplierMultiselectOptions');
            const countSpan = document.getElementById('supplierCount');
            
            // Clear existing options
            if (optionsContainer) {
                optionsContainer.innerHTML = '';
                
                suppliers.forEach(s => {
                    // Multiselect i√ßin
                    const isChecked = selectedSuppliers.has(s);
                    const option = document.createElement('div');
                    option.className = 'multiselect-option';
                    option.innerHTML = `
                        <input type="checkbox" id="supplier_${s.replace(/\s+/g, '_')}" 
                               ${isChecked ? 'checked' : ''} 
                               onchange="toggleSupplier('${s.replace(/'/g, "\\'")}')">
                        <label for="supplier_${s.replace(/\s+/g, '_')}">${s}</label>
                    `;
                    optionsContainer.appendChild(option);
                });
                
                updateSupplierMultiselectText();
            }
            
            // Form input dropdown'ƒ± g√ºncelle
            updateSupplierInputDropdown();
            
            // Tedarik√ßi sayƒ±sƒ±nƒ± g√∂ster
            if (countSpan) {
                if (suppliers.length === 0) {
                    countSpan.innerHTML = '(‚ö†Ô∏è Liste bo≈ü - Ana sayfada Excel y√ºkleyin)';
                    countSpan.style.color = '#f44336';
                } else {
                    countSpan.innerHTML = `(üìä ${suppliers.length} tedarik√ßi)`;
                    countSpan.style.color = '#4CAF50';
                }
            }
        }
        
        // Tedarik√ßi input dropdown'ƒ±nƒ± g√ºncelle
        function updateSupplierInputDropdown(filterText = '') {
            const itemsContainer = document.getElementById('supplierDropdownItems');
            const countElement = document.getElementById('supplierDropdownCount');
            
            if (!itemsContainer) return;
            
            const searchTerm = filterText.toLowerCase();
            const filtered = suppliers.filter(s => s.toLowerCase().includes(searchTerm));
            
            itemsContainer.innerHTML = '';
            
            if (filtered.length === 0) {
                itemsContainer.innerHTML = '<div class="supplier-dropdown-empty">üîç Tedarik√ßi bulunamadƒ±</div>';
                countElement.textContent = '0 tedarik√ßi';
                return;
            }
            
            countElement.textContent = `${filtered.length} tedarik√ßi`;
            
            filtered.forEach(s => {
                const item = document.createElement('div');
                item.className = 'supplier-dropdown-item';
                item.textContent = s;
                item.onclick = () => selectSupplier(s);
                itemsContainer.appendChild(item);
            });
        }
        
        // Dropdown'ƒ± g√∂ster
        function showSupplierDropdown() {
            const dropdown = document.getElementById('supplierDropdownList');
            const input = document.getElementById('supplierInput');
            
            if (suppliers.length === 0) {
                return;
            }
            
            updateSupplierInputDropdown(input.value);
            dropdown.classList.add('active');
        }
        
        // Dropdown'da arama yap
        function filterSupplierDropdown() {
            const input = document.getElementById('supplierInput');
            updateSupplierInputDropdown(input.value);
            showSupplierDropdown();
        }
        
        // Tedarik√ßi se√ß
        function selectSupplier(supplierName) {
            const input = document.getElementById('supplierInput');
            const dropdown = document.getElementById('supplierDropdownList');
            
            input.value = supplierName;
            dropdown.classList.remove('active');
            
            // Tedarik√ßi se√ßilince hammaddeleri filtrele
            filterMaterialsBySupplier();
        }
        
        // Dropdown dƒ±≈üƒ±na tƒ±klanƒ±nca kapat
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('supplierDropdownList');
            const input = document.getElementById('supplierInput');
            
            if (dropdown && input && !e.target.closest('.supplier-input-container')) {
                dropdown.classList.remove('active');
            }
        });
        
        function toggleSupplier(supplier) {
            if (selectedSuppliers.has(supplier)) {
                selectedSuppliers.delete(supplier);
            } else {
                selectedSuppliers.add(supplier);
            }
            updateSupplierMultiselectText();
            filterList();
        }
        
        function selectAllSuppliers() {
            selectedSuppliers.clear();
            suppliers.forEach(s => selectedSuppliers.add(s));
            updateSupplierDropdowns();
            filterList();
        }
        
        function clearAllSuppliers() {
            selectedSuppliers.clear();
            updateSupplierDropdowns();
            filterList();
        }
        
        function updateSupplierMultiselectText() {
            const text = document.getElementById('supplierMultiselectText');
            if (selectedSuppliers.size === 0) {
                text.textContent = 'T√ºm Tedarik√ßiler';
            } else if (selectedSuppliers.size === 1) {
                text.textContent = Array.from(selectedSuppliers)[0];
            } else {
                text.textContent = `${selectedSuppliers.size} tedarik√ßi se√ßili`;
            }
        }
        
        // ==================== Material Functions ====================
        function loadMaterials() {
            const savedMaterials = localStorage.getItem('coa_materials');
            if (savedMaterials) {
                try {
                    materials = JSON.parse(savedMaterials);
                    console.log('‚úÖ Hammadde listesi y√ºklendi:', materials.length);
                    updateMaterialDropdown();
                } catch (e) {
                    console.error('Hammadde parse hatasƒ±:', e);
                    materials = [];
                }
            }
        }
        
        function saveMaterials() {
            localStorage.setItem('coa_materials', JSON.stringify(materials));
            console.log('üíæ Hammadde listesi kaydedildi');
        }
        
        function loadMaterialJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    
                    // Veri formatƒ±nƒ± kontrol et
                    if (Array.isArray(jsonData)) {
                        materials = jsonData;
                    } else if (jsonData.materials && Array.isArray(jsonData.materials)) {
                        materials = jsonData.materials;
                    } else {
                        throw new Error('Ge√ßersiz JSON formatƒ±. Array veya {materials: []} bekleniyor.');
                    }
                    
                    // Verileri localStorage'a kaydet
                    saveMaterials();
                    updateMaterialDropdown();
                    
                    showToast(`‚úÖ ${materials.length} hammadde y√ºklendi!`, 'success');
                    console.log('üì¶ Hammadde JSON y√ºklendi:', materials);
                } catch (error) {
                    console.error('JSON parse hatasƒ±:', error);
                    showToast('‚ùå JSON dosyasƒ± okunamadƒ±: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
            
            // Input'u sƒ±fƒ±rla (aynƒ± dosya tekrar se√ßilebilsin)
            event.target.value = '';
        }
        
        function showMaterialDropdown() {
            const dropdown = document.getElementById('materialDropdown');
            dropdown.style.display = 'block';
            updateMaterialDropdown();
        }
        
        function hideMaterialDropdown() {
            setTimeout(() => {
                const dropdown = document.getElementById('materialDropdown');
                dropdown.style.display = 'none';
            }, 200);
        }
        
        function filterMaterials(searchText) {
            showMaterialDropdown();
            updateMaterialDropdown(searchText);
        }
        
        function updateMaterialDropdown(filterText = '') {
            const itemsContainer = document.getElementById('materialDropdownItems');
            const countElement = document.getElementById('materialDropdownCount');
            const materialCountLabel = document.getElementById('materialCount');
            
            if (!itemsContainer) return;
            
            // Se√ßili tedarik√ßiyi al
            const selectedSupplier = document.getElementById('supplierInput')?.value?.trim();
            
            const searchTerm = filterText.toLowerCase();
            const filtered = materials.filter(m => {
                const code = (m.code || m.stockCode || m.stokKodu || '').toLowerCase();
                const name = (m.name || m.stockName || m.stokAdƒ± || '').toLowerCase();
                const matchesSearch = code.includes(searchTerm) || name.includes(searchTerm);
                
                // Tedarik√ßi se√ßiliyse, sadece o tedarik√ßinin hammaddelerini g√∂ster
                if (selectedSupplier && m.suppliers && m.suppliers.length > 0) {
                    const matchesSupplier = m.suppliers.includes(selectedSupplier);
                    return matchesSearch && matchesSupplier;
                }
                
                return matchesSearch;
            });
            
            itemsContainer.innerHTML = '';
            
            if (filtered.length === 0 && materials.length === 0) {
                itemsContainer.innerHTML = '<div style="padding: 15px; text-align: center; color: #999;">üì¶ Hammadde listesi bo≈ü<br><small>JSON dosyasƒ± y√ºkleyin</small></div>';
                countElement.textContent = '0 hammadde';
                materialCountLabel.innerHTML = '<span style="color: #f44336;">(‚ö†Ô∏è Liste bo≈ü)</span>';
                return;
            }
            
            if (filtered.length === 0) {
                itemsContainer.innerHTML = '<div style="padding: 12px; text-align: center; color: #666;">üîç Sonu√ß bulunamadƒ±</div>';
                countElement.textContent = '0 sonu√ß';
                return;
            }
            
            countElement.textContent = `${filtered.length} hammadde`;
            materialCountLabel.innerHTML = `<span style="color: #4CAF50;">(üì¶ ${materials.length} hammadde)</span>`;
            
            filtered.forEach(material => {
                const code = material.code || material.stockCode || material.stokKodu || '';
                const name = material.name || material.stockName || material.stokAdƒ± || '';
                const displayText = `${code} - ${name}`;
                
                const item = document.createElement('div');
                item.className = 'supplier-dropdown-item';
                item.textContent = displayText;
                item.onclick = () => selectMaterial(code, name);
                itemsContainer.appendChild(item);
            });
        }
        
        function selectMaterial(code, name) {
            const input = document.getElementById('materialCode');
            input.value = `${code} - ${name}`;
            hideMaterialDropdown();
        }
        
        // Tedarik√ßi se√ßilince hammaddeleri filtrele
        function filterMaterialsBySupplier() {
            const selectedSupplier = document.getElementById('supplierInput')?.value?.trim();
            const materialInput = document.getElementById('materialCode');
            
            if (selectedSupplier) {
                // Hammadde dropdown'ƒ±nƒ± g√ºncelle
                updateMaterialDropdown(materialInput.value);
                
                // Placeholder'ƒ± g√ºncelle
                materialInput.placeholder = `üîç ${selectedSupplier} hammaddelerini ara...`;
                
                // Bilgi g√∂ster
                const filteredCount = materials.filter(m => 
                    m.suppliers && m.suppliers.includes(selectedSupplier)
                ).length;
                
                if (filteredCount > 0) {
                    showToast(`üì¶ ${selectedSupplier} i√ßin ${filteredCount} hammadde bulundu`, 'info', 2000);
                } else {
                    showToast(`‚ö†Ô∏è ${selectedSupplier} i√ßin hammadde bulunamadƒ±`, 'warning', 2000);
                }
            } else {
                // Tedarik√ßi se√ßili deƒüilse t√ºm hammaddeleri g√∂ster
                materialInput.placeholder = 'üîç Hammadde ara veya yazƒ±n...';
                updateMaterialDropdown(materialInput.value);
            }
        }
        
        // Dropdown dƒ±≈üƒ±na tƒ±klanƒ±nca kapat
        document.addEventListener('click', function(e) {
            const materialWrapper = document.querySelector('.supplier-dropdown-wrapper');
            const materialDropdown = document.getElementById('materialDropdown');
            
            if (materialWrapper && !materialWrapper.contains(e.target)) {
                if (materialDropdown) {
                    materialDropdown.style.display = 'none';
                }
            }
        });
        
        // ==================== File Upload ====================
        function initUploadArea() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#2d5a3d';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#ccc';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ccc';
                const file = e.dataTransfer.files[0];
                if (file) handleFile(file);
            });
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleFile(file);
            });
        }
        
        // PDF'i resme √ßevirip sƒ±kƒ±≈ütƒ±r (pdf.js kullanarak)
        async function compressPDF(file, maxSizeKB = 400) {
            return new Promise(async (resolve) => {
                try {
                    const maxSize = maxSizeKB * 1024;
                    
                    // PDF.js worker ayarla
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    
                    // Dosyayƒ± ArrayBuffer olarak oku
                    const arrayBuffer = await file.arrayBuffer();
                    
                    // PDF'i y√ºkle
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    const numPages = pdf.numPages;
                    
                    console.log('PDF sayfa sayƒ±sƒ±: ' + numPages);
                    showToast('üìÑ PDF ' + numPages + ' sayfa, d√∂n√º≈üt√ºr√ºl√ºyor...', 'info');
                    
                    // T√ºm sayfalarƒ± tek bir canvas'a √ßiz
                    const scale = 1.5; // Kalite i√ßin scale
                    let totalHeight = 0;
                    let maxWidth = 0;
                    const pageCanvases = [];
                    
                    // Her sayfayƒ± render et
                    for (let i = 1; i <= numPages; i++) {
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: scale });
                        
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        
                        await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                        
                        pageCanvases.push(canvas);
                        totalHeight += viewport.height;
                        if (viewport.width > maxWidth) maxWidth = viewport.width;
                    }
                    
                    // T√ºm sayfalarƒ± birle≈ütir
                    const finalCanvas = document.createElement('canvas');
                    finalCanvas.width = maxWidth;
                    finalCanvas.height = totalHeight;
                    const finalCtx = finalCanvas.getContext('2d');
                    finalCtx.fillStyle = 'white';
                    finalCtx.fillRect(0, 0, maxWidth, totalHeight);
                    
                    let yOffset = 0;
                    for (const canvas of pageCanvases) {
                        finalCtx.drawImage(canvas, 0, yOffset);
                        yOffset += canvas.height;
                    }
                    
                    // JPEG olarak sƒ±kƒ±≈ütƒ±r
                    let quality = 0.85;
                    let result = finalCanvas.toDataURL('image/jpeg', quality);
                    
                    while (result.length > maxSize && quality > 0.2) {
                        quality -= 0.1;
                        result = finalCanvas.toDataURL('image/jpeg', quality);
                    }
                    
                    // Hala b√ºy√ºkse boyutu k√º√ß√ºlt
                    if (result.length > maxSize) {
                        const scale2 = Math.sqrt(maxSize / result.length) * 0.9;
                        finalCanvas.width = Math.round(maxWidth * scale2);
                        finalCanvas.height = Math.round(totalHeight * scale2);
                        finalCtx.fillStyle = 'white';
                        finalCtx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
                        
                        yOffset = 0;
                        for (const canvas of pageCanvases) {
                            const newHeight = canvas.height * scale2;
                            finalCtx.drawImage(canvas, 0, yOffset, finalCanvas.width, newHeight);
                            yOffset += newHeight;
                        }
                        result = finalCanvas.toDataURL('image/jpeg', 0.7);
                    }
                    
                    console.log('PDF Sƒ±kƒ±≈ütƒ±rma: ' + Math.round(file.size/1024) + 'KB -> ' + Math.round(result.length/1024) + 'KB');
                    resolve({ 
                        data: result, 
                        compressed: true, 
                        originalSize: file.size, 
                        newSize: result.length,
                        convertedToImage: true
                    });
                    
                } catch (error) {
                    console.error('PDF sƒ±kƒ±≈ütƒ±rma hatasƒ±:', error);
                    // Hata olursa orijinal dosyayƒ± d√∂nd√ºr
                    const reader = new FileReader();
                    reader.onload = (e) => resolve({ data: e.target.result, compressed: false, error: error.message });
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // Resmi sƒ±kƒ±≈ütƒ±r (max 500KB)
        async function compressImage(file, maxSizeKB = 400) {
            return new Promise((resolve) => {
                const maxSize = maxSizeKB * 1024;
                
                // Resim deƒüilse direkt oku
                if (!file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve({ data: e.target.result, compressed: false });
                    reader.readAsDataURL(file);
                    return;
                }
                
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;
                    
                    // Max boyut 1920px
                    const maxDim = 1920;
                    if (width > maxDim || height > maxDim) {
                        if (width > height) {
                            height = Math.round(height * maxDim / width);
                            width = maxDim;
                        } else {
                            width = Math.round(width * maxDim / height);
                            height = maxDim;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Kaliteyi d√º≈ü√ºrerek sƒ±kƒ±≈ütƒ±r
                    let quality = 0.9;
                    let result = canvas.toDataURL('image/jpeg', quality);
                    
                    while (result.length > maxSize && quality > 0.1) {
                        quality -= 0.1;
                        result = canvas.toDataURL('image/jpeg', quality);
                    }
                    
                    // Hala b√ºy√ºkse boyutu k√º√ß√ºlt
                    if (result.length > maxSize) {
                        const scale = Math.sqrt(maxSize / result.length);
                        canvas.width = Math.round(width * scale);
                        canvas.height = Math.round(height * scale);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        result = canvas.toDataURL('image/jpeg', 0.8);
                    }
                    
                    console.log('Sƒ±kƒ±≈ütƒ±rma: ' + Math.round(file.size/1024) + 'KB -> ' + Math.round(result.length/1024) + 'KB');
                    resolve({ data: result, compressed: true, originalSize: file.size, newSize: result.length });
                };
                
                img.src = URL.createObjectURL(file);
            });
        }
        
        async function handleFile(file) {
            selectedFile = file;
            const uploadArea = document.getElementById('uploadArea');
            const preview = document.getElementById('filePreview');
            
            uploadArea.classList.add('has-file');
            
            const fileSizeKB = Math.round(file.size / 1024);
            showToast('üìÅ Dosya: ' + file.name + ' (' + fileSizeKB + 'KB)', 'info');
            
            // PDF sƒ±kƒ±≈ütƒ±rma (400KB √ºst√º)
            if (file.type === 'application/pdf' && file.size > 400 * 1024) {
                showToast('üîÑ PDF resme d√∂n√º≈üt√ºr√ºl√ºyor ve sƒ±kƒ±≈ütƒ±rƒ±lƒ±yor...', 'info');
                
                const compressed = await compressPDF(file, 400);
                selectedFileData = compressed.data;
                
                // Dosya tipini image/jpeg olarak deƒüi≈ütir
                selectedFile = new File([selectedFile], file.name.replace('.pdf', '.jpg'), { type: 'image/jpeg' });
                
                if (compressed.compressed) {
                    const newSizeKB = Math.round(compressed.newSize / 1024);
                    showToast('‚úÖ PDF sƒ±kƒ±≈ütƒ±rƒ±ldƒ±: ' + fileSizeKB + 'KB -> ' + newSizeKB + 'KB', 'success');
                    preview.innerHTML = '<div class="file-name" style="color:green;">üìÑ ' + file.name + ' (resme d√∂n√º≈üt√ºr√ºld√º)</div>' +
                        '<img src="' + selectedFileData + '" class="preview-image" style="max-height:300px;">';
                } else {
                    showToast('‚ö†Ô∏è PDF d√∂n√º≈üt√ºr√ºlemedi: ' + (compressed.error || ''), 'warning');
                    preview.innerHTML = '<div class="file-name" style="color:orange;">üìÑ ' + file.name + '</div>';
                }
            }
            // Resim sƒ±kƒ±≈ütƒ±rma (400KB √ºst√º)
            else if (file.type.startsWith('image/') && file.size > 400 * 1024) {
                showToast('üîÑ Resim sƒ±kƒ±≈ütƒ±rƒ±lƒ±yor...', 'info');
                const compressed = await compressImage(file, 400);
                selectedFileData = compressed.data;
                
                if (compressed.compressed) {
                    const newSizeKB = Math.round(compressed.newSize / 1024);
                    showToast('‚úÖ Sƒ±kƒ±≈ütƒ±rƒ±ldƒ±: ' + fileSizeKB + 'KB -> ' + newSizeKB + 'KB', 'success');
                }
                
                preview.innerHTML = '<div class="file-name">üì∑ ' + file.name + ' (sƒ±kƒ±≈ütƒ±rƒ±lmƒ±≈ü)</div>' +
                    '<img src="' + selectedFileData + '" class="preview-image">';
            }
            // K√º√ß√ºk PDF (400KB altƒ±)
            else if (file.type === 'application/pdf') {
                showToast('üîÑ PDF resme d√∂n√º≈üt√ºr√ºl√ºyor...', 'info');
                
                const compressed = await compressPDF(file, 400);
                selectedFileData = compressed.data;
                selectedFile = new File([selectedFile], file.name.replace('.pdf', '.jpg'), { type: 'image/jpeg' });
                
                const newSizeKB = Math.round(compressed.newSize / 1024);
                showToast('‚úÖ PDF d√∂n√º≈üt√ºr√ºld√º: ' + newSizeKB + 'KB', 'success');
                preview.innerHTML = '<div class="file-name" style="color:green;">üìÑ ' + file.name + ' (resme d√∂n√º≈üt√ºr√ºld√º)</div>' +
                    '<img src="' + selectedFileData + '" class="preview-image" style="max-height:300px;">';
            }
            // K√º√ß√ºk resim veya diƒüer dosyalar
            else {
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedFileData = e.target.result;
                    
                    if (file.type.startsWith('image/')) {
                        preview.innerHTML = '<div class="file-name">üì∑ ' + file.name + '</div>' +
                            '<img src="' + e.target.result + '" class="preview-image">';
                    } else {
                        preview.innerHTML = '<div class="file-name">üìÑ ' + file.name + '</div>';
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        
        // ==================== CRUD Operations ====================
        async function saveCOA() {
            const supplier = document.getElementById('supplierInput').value.trim();
            const materialCode = document.getElementById('materialCode').value.trim();
            const deliveryDate = document.getElementById('deliveryDate').value;
            const deliveryNo = document.getElementById('deliveryNo').value.trim();
            const lotNumber = document.getElementById('lotNumber').value.trim();
            const location = document.getElementById('location').value;
            const notes = document.getElementById('notes').value.trim();
            
            // Validation
            if (!supplier) {
                showToast('‚ùå Tedarik√ßi adƒ± girin!', 'error');
                return;
            }
            if (!materialCode) {
                showToast('‚ùå Hammadde kodu girin!', 'error');
                return;
            }
            if (!deliveryDate) {
                showToast('‚ùå ƒ∞rsaliye tarihi girin!', 'error');
                return;
            }
            
            // Edit mode - dosya opsiyonel
            if (editMode) {
                const existingRecord = coaData.find(c => c.id === editingId);
                if (!existingRecord) {
                    showToast('‚ùå Kayƒ±t bulunamadƒ±!', 'error');
                    return;
                }
                
                // Yeni dosya y√ºklendiyse Drive'a upload et
                let uploadResult = null;
                if (selectedFileData) {
                    showToast('‚òÅÔ∏è Yeni dosya Drive\'a y√ºkleniyor...', 'info');
                    
                    try {
                        // XMLHttpRequest POST (b√ºy√ºk veri i√ßin)
                        const compressedData = await compressForSheets(selectedFileData, 250);
                        console.log('Sƒ±kƒ±≈ütƒ±rƒ±lmƒ±≈ü boyut:', Math.round(compressedData.length / 1024), 'KB');
                        
                        uploadResult = await new Promise((resolve, reject) => {
                            const xhr = new XMLHttpRequest();
                            xhr.timeout = 60000;
                            
                            xhr.onload = function() {
                                if (xhr.status === 200) {
                                    try {
                                        resolve(JSON.parse(xhr.responseText));
                                    } catch(e) {
                                        reject(new Error('JSON parse hatasƒ±'));
                                    }
                                } else {
                                    reject(new Error('HTTP ' + xhr.status));
                                }
                            };
                            
                            xhr.onerror = () => reject(new Error('Baƒülantƒ± hatasƒ±'));
                            xhr.ontimeout = () => reject(new Error('Zaman a≈üƒ±mƒ±'));
                            
                            xhr.open('POST', googleScriptUrl, true);
                            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                            
                            const formData = new URLSearchParams();
                            formData.append('action', 'uploadFile');
                            formData.append('fileData', compressedData);
                            formData.append('fileName', selectedFile.name);
                            formData.append('mimeType', selectedFile.type || 'image/jpeg');
                            
                            xhr.send(formData.toString());
                        });
                        
                        console.log('Drive upload sonucu:', uploadResult);
                        
                        if (!uploadResult || !uploadResult.success) {
                            showToast('‚ùå Dosya y√ºklenemedi: ' + (uploadResult?.error || 'Bilinmeyen hata'), 'error');
                            return;
                        }
                        showToast('‚úÖ Dosya Drive\'a y√ºklendi!', 'success');
                    } catch (uploadErr) {
                        console.error('Drive upload hatasƒ±:', uploadErr);
                        showToast('‚ùå Dosya y√ºkleme hatasƒ±: ' + uploadErr.message, 'error');
                        return;
                    }
                }
                
                // Record olu≈ütur - yeni dosya varsa onun bilgilerini kullan, yoksa eski dosyayƒ± koru
                const record = {
                    id: editingId,
                    supplier: supplier,
                    materialCode: materialCode,
                    deliveryDate: deliveryDate,
                    deliveryNo: deliveryNo,
                    lotNumber: lotNumber,
                    location: location,
                    notes: notes,
                    fileName: uploadResult ? uploadResult.fileName : existingRecord.fileName,
                    fileType: uploadResult ? selectedFile.type : existingRecord.fileType,
                    fileData: uploadResult ? selectedFileData : existingRecord.fileData,
                    fileUrl: uploadResult ? uploadResult.viewUrl : existingRecord.fileUrl,
                    driveFileId: uploadResult ? uploadResult.fileId : existingRecord.driveFileId,
                    fileSize: uploadResult ? uploadResult.fileSize : existingRecord.fileSize, // Ger√ßek boyut
                    createdAt: existingRecord.createdAt,
                    updatedAt: new Date().toISOString()
                };
                
                // Google Sheets'e g√ºncelle
                if (googleScriptUrl) {
                    const result = await updateToGoogleSheets(record);
                    if (result) {
                        const idx = coaData.findIndex(c => c.id === editingId);
                        if (idx >= 0) {
                            coaData[idx] = record;
                        }
                        saveToLocalStorage();
                        showToast('‚úÖ COA g√ºncellendi!', 'success');
                    }
                } else {
                    const idx = coaData.findIndex(c => c.id === editingId);
                    if (idx >= 0) {
                        coaData[idx] = record;
                    }
                    saveToLocalStorage();
                    showToast('‚úÖ Yerel olarak g√ºncellendi!', 'success');
                }
                
                cancelEdit();
                updateUI();
                return;
            }
            
            // Yeni kayƒ±t - dosya zorunlu
            if (!selectedFileData) {
                showToast('‚ùå Sertifika dosyasƒ± y√ºkleyin!', 'error');
                return;
            }
            
            // √ñnce Drive'a y√ºkle
            showToast('‚òÅÔ∏è Dosya Drive\'a y√ºkleniyor...', 'info');
            let uploadResult = null;
            
            try {
                const compressedData = await compressForSheets(selectedFileData, 250);
                console.log('Sƒ±kƒ±≈ütƒ±rƒ±lmƒ±≈ü boyut:', Math.round(compressedData.length / 1024), 'KB');
                
                uploadResult = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.timeout = 60000;
                    
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            try {
                                resolve(JSON.parse(xhr.responseText));
                            } catch(e) {
                                reject(new Error('JSON parse hatasƒ±'));
                            }
                        } else {
                            reject(new Error('HTTP ' + xhr.status));
                        }
                    };
                    
                    xhr.onerror = () => reject(new Error('Baƒülantƒ± hatasƒ±'));
                    xhr.ontimeout = () => reject(new Error('Zaman a≈üƒ±mƒ±'));
                    
                    xhr.open('POST', googleScriptUrl, true);
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    
                    const formData = new URLSearchParams();
                    formData.append('action', 'uploadFile');
                    formData.append('fileData', compressedData);
                    formData.append('fileName', selectedFile.name);
                    formData.append('mimeType', selectedFile.type || 'image/jpeg');
                    
                    xhr.send(formData.toString());
                });
                
                console.log('Drive upload sonucu:', uploadResult);
                
                if (!uploadResult || !uploadResult.success) {
                    showToast('‚ùå Dosya y√ºklenemedi: ' + (uploadResult?.error || 'Bilinmeyen hata'), 'error');
                    return;
                }
                showToast('‚úÖ Dosya Drive\'a y√ºklendi!', 'success');
            } catch (uploadErr) {
                console.error('Drive upload hatasƒ±:', uploadErr);
                showToast('‚ùå Dosya y√ºkleme hatasƒ±: ' + uploadErr.message, 'error');
                return;
            }
            
            const record = {
                id: 'coa_' + Date.now(),
                supplier: supplier,
                materialCode: materialCode,
                deliveryDate: deliveryDate,
                deliveryNo: deliveryNo,
                lotNumber: lotNumber,
                location: location,
                notes: notes,
                fileName: uploadResult.fileName,
                fileType: selectedFile.type,
                fileData: selectedFileData,
                fileUrl: uploadResult.viewUrl,
                driveFileId: uploadResult.fileId,
                fileSize: uploadResult.fileSize, // Ger√ßek dosya boyutu (bytes)
                createdAt: new Date().toISOString()
            };
            
            // Save
            if (googleScriptUrl) {
                const success = await saveToGoogleSheets(record);
                if (success) {
                    coaData.unshift(record);
                    showToast('‚úÖ Google Sheets\'e kaydedildi!', 'success');
                } else {
                    showToast('‚ùå Kayƒ±t hatasƒ±!', 'error');
                    return;
                }
            } else {
                coaData.unshift(record);
                saveToLocalStorage();
                showToast('‚úÖ Yerel olarak kaydedildi!', 'success');
            }
            
            // Reset form
            clearForm();
            updateUI();
            loadSuppliers();
        }
        
        function clearForm() {
            document.getElementById('supplierInput').value = '';
            document.getElementById('materialCode').value = '';
            document.getElementById('deliveryDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('deliveryNo').value = '';
            document.getElementById('lotNumber').value = '';
            document.getElementById('location').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('filePreview').innerHTML = '';
            document.getElementById('uploadArea').classList.remove('has-file');
            selectedFile = null;
            selectedFileData = null;
            editMode = false;
            editingId = null;
            document.getElementById('saveBtn').textContent = 'üíæ Kaydet';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }
        
        function editCOA(id) {
            const record = coaData.find(c => c.id === id);
            if (!record) {
                showToast('‚ùå Kayƒ±t bulunamadƒ±!', 'error');
                return;
            }
            
            // Forma verileri doldur
            document.getElementById('supplierInput').value = record.supplier || '';
            document.getElementById('materialCode').value = record.materialCode || '';
            // Tarih formatƒ±nƒ± d√ºzelt (YYYY-MM-DD)
            const deliveryDate = record.deliveryDate || '';
            document.getElementById('deliveryDate').value = deliveryDate.split('T')[0];
            document.getElementById('deliveryNo').value = record.deliveryNo || '';
            document.getElementById('lotNumber').value = record.lotNumber || '';
            document.getElementById('location').value = record.location || '';
            document.getElementById('notes').value = record.notes || '';
            
            // Mevcut dosya √∂nizlemesi
            if (record.fileData) {
                const preview = document.getElementById('filePreview');
                if (record.fileType?.startsWith('image/')) {
                    preview.innerHTML = '<img src="' + record.fileData + '" style="max-width: 100%; max-height: 200px; border-radius: 8px;"><p style="margin-top: 10px; color: #666;">Mevcut dosya: ' + record.fileName + '</p><p style="font-size: 0.9em; color: #999;">Yeni dosya y√ºklerseniz deƒüi≈ütirilir</p>';
                } else {
                    preview.innerHTML = '<div class="pdf-icon">PDF</div><p style="margin-top: 10px; color: #666;">Mevcut dosya: ' + record.fileName + '</p><p style="font-size: 0.9em; color: #999;">Yeni dosya y√ºklerseniz deƒüi≈ütirilir</p>';
                }
                document.getElementById('uploadArea').classList.add('has-file');
            }
            
            // Edit mode'a ge√ß
            editMode = true;
            editingId = id;
            document.getElementById('saveBtn').textContent = '‚úèÔ∏è G√ºncelle';
            document.getElementById('cancelEditBtn').style.display = 'block';
            
            // Forma scroll
            document.querySelector('.card').scrollIntoView({ behavior: 'smooth', block: 'start' });
            showToast('üìù D√ºzenleme modu aktif', 'info');
        }
        
        function cancelEdit() {
            clearForm();
            showToast('‚ùå D√ºzenleme iptal edildi', 'info');
        }
        
        function toggleRowSelection(id) {
            if (selectedItems.has(id)) {
                selectedItems.delete(id);
            } else {
                selectedItems.add(id);
            }
            updateBulkActions();
        }
        
        function toggleSelectAll() {
            const filtered = getFilteredData();
            const headerCheckbox = document.getElementById('headerCheckbox');
            
            if (headerCheckbox.checked) {
                // T√ºm√ºn√º se√ß
                filtered.forEach(c => selectedItems.add(c.id));
            } else {
                // T√ºm√ºn√º kaldƒ±r
                filtered.forEach(c => selectedItems.delete(c.id));
            }
            
            renderTable();
            updateBulkActions();
        }
        
        function updateBulkActions() {
            const count = selectedItems.size;
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const countSpan = document.getElementById('selectedCount');
            const headerCheckbox = document.getElementById('headerCheckbox');
            
            countSpan.textContent = count;
            
            if (count > 0) {
                deleteBtn.style.display = 'inline-block';
            } else {
                deleteBtn.style.display = 'none';
            }
            
            // Header checkbox durumu
            if (headerCheckbox) {
                const filtered = getFilteredData();
                const allSelected = filtered.length > 0 && filtered.every(c => selectedItems.has(c.id));
                headerCheckbox.checked = allSelected;
            }
        }
        
        async function deleteSelected() {
            if (selectedItems.size === 0) {
                showToast('‚ùå Silinecek kayƒ±t se√ßin!', 'error');
                return;
            }
            
            if (!confirm(`${selectedItems.size} adet kaydƒ± silmek istediƒüinizden emin misiniz?`)) {
                return;
            }
            
            const idsToDelete = Array.from(selectedItems);
            let successCount = 0;
            
            for (const id of idsToDelete) {
                if (googleScriptUrl) {
                    await deleteFromGoogleSheets(id);
                }
                
                coaData = coaData.filter(c => c.id !== id);
                selectedItems.delete(id);
                successCount++;
            }
            
            saveToLocalStorage();
            updateUI();
            showToast(`‚úÖ ${successCount} kayƒ±t silindi!`, 'success');
        }
        
        async function deleteCOA(id) {
            if (!confirm('Bu sertifikayƒ± silmek istediƒüinizden emin misiniz?')) return;
            
            if (googleScriptUrl) {
                await deleteFromGoogleSheets(id);
            }
            
            coaData = coaData.filter(c => c.id !== id);
            saveToLocalStorage();
            updateUI();
            showToast('‚úÖ Silindi!', 'success');
        }
        
        function viewFile(id) {
            const record = coaData.find(c => c.id === id);
            if (!record) {
                showToast('‚ùå Kayƒ±t bulunamadƒ±', 'error');
                return;
            }
            
            // √ñnce yerel dosya verisi kontrol et (localStorage'da)
            if (record.fileData) {
                if (record.fileType === 'application/pdf' || record.fileName?.endsWith('.pdf')) {
                    const pdfWindow = window.open();
                    pdfWindow.document.write(`
                        <html>
                        <head><title>${record.fileName || 'COA PDF'}</title></head>
                        <body style="margin:0;padding:0;">
                        <iframe src="${record.fileData}" style="width:100%;height:100%;border:none;"></iframe>
                        </body>
                        </html>
                    `);
                } else {
                    document.getElementById('modalImage').src = record.fileData;
                    document.getElementById('imageModal').classList.add('active');
                }
                return;
            }
            
            // URL varsa onu kullan
            if (record.fileUrl) {
                window.open(record.fileUrl, '_blank');
                return;
            }
            
            showToast('‚ùå Dosya bulunamadƒ± - Bu kayƒ±t dosyasƒ±z veya dosya y√ºklenemedi', 'error');
        }
        
        function closeModal() {
            document.getElementById('imageModal').classList.remove('active');
        }
        
        function downloadFile(id) {
            const record = coaData.find(c => c.id === id);
            if (!record) {
                showToast('‚ùå Kayƒ±t bulunamadƒ±', 'error');
                return;
            }
            
            // √ñnce yerel dosya verisi kontrol et
            if (record.fileData) {
                const link = document.createElement('a');
                link.href = record.fileData;
                link.download = record.fileName || 'coa_file';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                return;
            }
            
            // URL varsa yeni sekmede a√ß
            if (record.fileUrl) {
                window.open(record.fileUrl, '_blank');
                return;
            }
            
            showToast('‚ùå Dosya bulunamadƒ±', 'error');
        }
        
        // ==================== UI Updates ====================
        function updateUI() {
            updateStats();
            renderTable();
            updateBulkActions();
        }
        
        function updateStats() {
            document.getElementById('statTotal').textContent = coaData.length;
            
            const uniqueSuppliers = [...new Set(coaData.map(c => c.supplier))];
            document.getElementById('statSuppliers').textContent = uniqueSuppliers.length;
            
            const thisMonth = new Date().toISOString().slice(0, 7);
            const thisMonthCount = coaData.filter(c => c.deliveryDate?.startsWith(thisMonth)).length;
            document.getElementById('statThisMonth').textContent = thisMonthCount;
            
            // Toplam dosya boyutunu hesapla - √∂nce fileSize kullan, yoksa fileData'dan hesapla
            let totalBytes = 0;
            let fromFileSize = 0;
            let fromFileData = 0;
            
            coaData.forEach(c => {
                if (c.fileSize) {
                    // Drive'dan gelen ger√ßek dosya boyutu (bytes)
                    totalBytes += parseInt(c.fileSize);
                    fromFileSize++;
                } else if (c.fileData) {
                    // Base64 boyutunu ger√ßek boyuta √ßevir (base64 %33 daha b√ºy√ºk)
                    const base64Length = c.fileData.length;
                    const realSize = Math.ceil(base64Length * 0.75);
                    totalBytes += realSize;
                    fromFileData++;
                }
            });
            
            const totalMB = (totalBytes / (1024 * 1024)).toFixed(2);
            document.getElementById('statTotalSize').textContent = totalMB + ' MB';
            
            console.log('üìä Dosya boyutu istatistikleri:');
            console.log('- fileSize kullanan:', fromFileSize);
            console.log('- fileData kullanan:', fromFileData);
            console.log('- Toplam:', totalMB, 'MB');
        }
        
        function renderTable() {
            const tbody = document.getElementById('coaTableBody');
            const emptyState = document.getElementById('emptyState');
            const table = document.getElementById('coaTable');
            
            const filtered = getFilteredData();
            
            if (filtered.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            table.style.display = 'table';
            emptyState.style.display = 'none';
            
            tbody.innerHTML = filtered.map(c => {
                const isChecked = selectedItems.has(c.id) ? 'checked' : '';
                
                // Dosya √∂nizlemesi - √∂nce fileData, sonra URL
                let filePreview;
                if (c.fileData && (c.fileType?.startsWith('image/') || c.fileName?.match(/\.(jpg|jpeg|png|gif|webp)$/i))) {
                    filePreview = '<img src="' + c.fileData + '" class="thumbnail" onclick="viewFile(\'' + c.id + '\')">';
                } else if (c.fileUrl && c.fileType?.startsWith('image/')) {
                    const directUrl = c.fileUrl.replace('/view', '/preview');
                    filePreview = '<img src="' + directUrl + '" class="thumbnail" onclick="viewFile(\'' + c.id + '\')">';
                } else {
                    filePreview = '<div class="pdf-icon" onclick="viewFile(\'' + c.id + '\')">PDF</div>';
                }
                
                const onlineIcon = c.fileData ? ' üíæ' : (c.fileUrl ? ' ‚òÅÔ∏è' : '');
                
                // Dosya boyutunu hesapla
                let fileSizeDisplay = '-';
                if (c.fileSize) {
                    const sizeInMB = (c.fileSize / (1024 * 1024)).toFixed(2);
                    fileSizeDisplay = sizeInMB + ' MB';
                } else if (c.fileData) {
                    const base64Length = c.fileData.length;
                    const sizeInBytes = Math.ceil(base64Length * 0.75);
                    const sizeInMB = (sizeInBytes / (1024 * 1024)).toFixed(2);
                    fileSizeDisplay = sizeInMB + ' MB';
                }
                
                return '<tr>' +
                    '<td><input type="checkbox" class="row-checkbox" data-id="' + c.id + '" onchange="toggleRowSelection(\'' + c.id + '\')" ' + isChecked + ' style="cursor: pointer;"></td>' +
                    '<td>' + filePreview + '</td>' +
                    '<td><strong>' + c.supplier + '</strong>' + onlineIcon + '</td>' +
                    '<td>' + c.materialCode + '</td>' +
                    '<td>' + formatDate(c.deliveryDate) + '</td>' +
                    '<td>' + (c.deliveryNo || '-') + '</td>' +
                    '<td>' + (c.lotNumber || '-') + '</td>' +
                    '<td style="font-size: 0.85em; color: #666;">' + fileSizeDisplay + '</td>' +
                    '<td>' + (c.location || '-') + '</td>' +
                    '<td class="actions">' +
                        '<button class="btn btn-secondary btn-sm" onclick="viewFile(\'' + c.id + '\')" title="G√∂r√ºnt√ºle">üëÅ</button>' +
                        '<button class="btn btn-secondary btn-sm" onclick="downloadFile(\'' + c.id + '\')" title="ƒ∞ndir">üì•</button>' +
                        '<button class="btn btn-primary btn-sm" onclick="editCOA(\'' + c.id + '\')" title="D√ºzenle">‚úèÔ∏è</button>' +
                        '<button class="btn btn-danger btn-sm" onclick="deleteCOA(\'' + c.id + '\')" title="Sil">üóë</button>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }
        
        function getFilteredData() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const month = document.getElementById('filterMonth').value;
            
            return coaData.filter(c => {
                const matchSearch = !search || 
                    String(c.supplier || '').toLowerCase().includes(search) ||
                    String(c.materialCode || '').toLowerCase().includes(search) ||
                    String(c.deliveryNo || '').toLowerCase().includes(search) ||
                    String(c.lotNumber || '').toLowerCase().includes(search) ||
                    String(c.location || '').toLowerCase().includes(search);
                    
                // √áoklu tedarik√ßi filtresi: Hi√ß se√ßilmemi≈üse t√ºm√ºn√º g√∂ster, se√ßilmi≈üse sadece se√ßilenleri g√∂ster
                const matchSupplier = selectedSuppliers.size === 0 || selectedSuppliers.has(c.supplier);
                const matchMonth = !month || String(c.deliveryDate || '').startsWith(month);
                
                return matchSearch && matchSupplier && matchMonth;
            });
        }
        
        function filterList() {
            renderTable();
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('tr-TR');
        }
        
        // ==================== Toast ====================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }
        
        // Close modal on click outside
        document.getElementById('imageModal').addEventListener('click', (e) => {
            if (e.target.id === 'imageModal') closeModal();
        });
    </script>
</body>
</html>